<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>California Race Crime — By the Numbers</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Source+Code+Pro:wght@400;600&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-primary: #0a0a0f;
  --bg-card: #12121a;
  --bg-card-hover: #1a1a28;
  --accent-red: #e63946;
  --accent-gold: #e8853a;
  --accent-blue: #4682B4;
  --accent-cyan: #00d4ff;
  --text-primary: #e8e8ec;
  --text-secondary: #8a8a9a;
  --text-muted: #55556a;
  --border: #2a2a3a;
  --white: #ffffff;
  --black-race: #7a8a9a;
  --hispanic-race: #e8853a;
  --white-race: #4682B4;
  --other-race: #e8d44d;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }

body {
  background: var(--bg-primary);
  color: var(--text-primary);
  font-family: 'DM Sans', sans-serif;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* ============ GRAIN & SCANLINES ============ */
.grain {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  pointer-events: none;
  z-index: 9999;
  opacity: 0.03;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
  background-repeat: repeat;
  background-size: 256px;
}

.scanlines {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  pointer-events: none;
  z-index: 9998;
  background: repeating-linear-gradient(
    0deg,
    transparent,
    transparent 2px,
    rgba(0,0,0,0.03) 2px,
    rgba(0,0,0,0.03) 4px
  );
}

/* ============ SECTION DIVIDERS ============ */
/* Offset scroll targets for fixed nav */
section[id] { scroll-margin-top: 70px; }

.section-divider {
  position: relative;
  height: 120px;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}

.divider-line {
  width: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--accent-red), transparent);
  transition: width 1.5s ease;
}

.divider-line.visible {
  width: 80%;
}

.divider-text {
  position: absolute;
  font-family: 'Source Code Pro', monospace;
  font-size: 10px;
  letter-spacing: 6px;
  text-transform: uppercase;
  color: var(--accent-red);
  background: var(--bg-primary);
  padding: 0 20px;
  opacity: 0;
  transition: opacity 0.8s ease 0.5s;
}

.divider-text.visible {
  opacity: 1;
}

/* ============ AUDIO CONTROL ============ */
.audio-control {
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: 500;
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: var(--bg-card);
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  opacity: 0;
  animation: fadeSlideUp 0.5s ease 2s forwards;
}

.audio-control:hover {
  border-color: var(--accent-red);
  transform: scale(1.1);
}

.audio-bars {
  display: flex;
  align-items: flex-end;
  gap: 2px;
  height: 16px;
}

.audio-bar {
  width: 3px;
  background: var(--accent-red);
  border-radius: 1px;
  transition: height 0.2s ease;
}

.audio-bar.playing { animation: audioWave 0.8s ease infinite alternate; }

.audio-bar:nth-child(1) { height: 6px; animation-delay: 0s; }
.audio-bar:nth-child(2) { height: 10px; animation-delay: 0.15s; }
.audio-bar:nth-child(3) { height: 14px; animation-delay: 0.3s; }
.audio-bar:nth-child(4) { height: 8px; animation-delay: 0.45s; }

.audio-bar.muted { height: 3px !important; animation: none; background: var(--text-muted); }

@keyframes audioWave {
  0% { height: 4px; }
  100% { height: 16px; }
}

@keyframes fadeSlideUp {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ============ NAVIGATION ============ */
.nav {
  position: fixed;
  top: 0; left: 0; right: 0;
  z-index: 500;
  padding: 16px 30px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(10,10,15,0.85);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid rgba(255,255,255,0.04);
  transform: translateY(-100%);
  transition: transform 0.3s ease;
}

.nav.visible { transform: translateY(0); }

.nav-logo {
  font-family: 'Playfair Display', serif;
  font-size: 16px;
  font-weight: 700;
  color: var(--text-primary);
}

.nav-links { display: flex; gap: 28px; }

.nav-links a {
  font-size: 12px;
  color: var(--text-muted);
  text-decoration: none;
  text-transform: uppercase;
  letter-spacing: 1px;
  cursor: pointer;
  transition: color 0.3s ease;
}

.nav-links a:hover { color: var(--text-primary); }

@media (max-width: 600px) {
  .nav-links { gap: 14px; }
  .nav-links a { font-size: 10px; }
}

/* ============ HERO ============ */
.hero {
  min-height: 100vh;
  min-height: 100dvh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  position: relative;
  padding: 60px 20px;
  overflow: hidden;
}

.hero::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: 
    radial-gradient(ellipse 80% 60% at 50% 40%, rgba(230,57,70,0.06) 0%, transparent 70%),
    radial-gradient(ellipse 50% 40% at 30% 70%, rgba(0,212,255,0.03) 0%, transparent 60%);
  pointer-events: none;
}

/* Animated fog */
.hero-fog {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  pointer-events: none;
  overflow: hidden;
}

.fog-layer {
  position: absolute;
  width: 200%;
  height: 100%;
  background: linear-gradient(90deg, 
    transparent 0%, 
    rgba(230,57,70,0.02) 20%,
    transparent 40%,
    rgba(0,212,255,0.015) 60%,
    transparent 80%
  );
  animation: fogDrift 30s linear infinite;
}

.fog-layer:nth-child(2) {
  animation-duration: 45s;
  animation-direction: reverse;
  opacity: 0.7;
}

@keyframes fogDrift {
  from { transform: translateX(-50%); }
  to { transform: translateX(0%); }
}

.hero-badge {
  font-family: 'Source Code Pro', monospace;
  font-size: 13px;
  font-weight: 600;
  letter-spacing: 5px;
  text-transform: uppercase;
  color: var(--accent-red);
  border: 2px solid rgba(230,57,70,0.6);
  padding: 12px 28px;
  margin-bottom: 40px;
  position: relative;
  transform: rotate(-2.5deg);
  animation: stampSlam 0.5s cubic-bezier(0.22, 0.68, 0.35, 1.2) 0.3s both;
  text-shadow: 0 0 20px rgba(230,57,70,0.4);
  box-shadow: 
    0 0 30px rgba(230,57,70,0.15),
    inset 0 0 20px rgba(230,57,70,0.05);
}

/* Crack lines from stamp impact */
.hero-badge::before {
  content: '';
  position: absolute;
  top: 50%;
  left: -20px;
  width: 18px;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(230,57,70,0.5));
  transform: rotate(-8deg);
  opacity: 0;
  animation: crackAppear 0.2s ease 0.75s both;
}

.hero-badge::after {
  content: '';
  position: absolute;
  top: 40%;
  right: -25px;
  width: 22px;
  height: 1px;
  background: linear-gradient(270deg, transparent, rgba(230,57,70,0.4));
  transform: rotate(12deg);
  opacity: 0;
  animation: crackAppear 0.2s ease 0.8s both;
}

/* The hero shakes on stamp impact */
.hero {
  animation: screenShake 0.4s cubic-bezier(0.36, 0.07, 0.19, 0.97) 0.7s;
}

.hero-title {
  font-family: 'Playfair Display', serif;
  font-size: clamp(42px, 7vw, 90px);
  font-weight: 900;
  text-align: center;
  line-height: 1.2;
  max-width: 900px;
  animation: fadeIn 1s ease 1.0s both;
  letter-spacing: -1px;
}

.hero-title em {
  font-style: italic;
  color: var(--accent-red);
}

.hero-race {
  display: inline-block;
  font-family: 'Source Code Pro', monospace;
  font-size: clamp(28px, 5vw, 56px);
  font-weight: 700;
  letter-spacing: 10px;
  text-transform: uppercase;
  color: #fff;
  background: rgba(230,57,70,0.15);
  border: 3px solid rgba(230,57,70,0.8);
  outline: 1px solid rgba(230,57,70,0.3);
  outline-offset: 3px;
  padding: 6px 22px;
  margin: 0 10px;
  position: relative;
  transform: rotate(-3.5deg);
  animation: stampSlam 0.5s cubic-bezier(0.22, 0.68, 0.35, 1.2) 1.1s both;
  text-shadow: 0 0 30px rgba(230,57,70,0.6);
  box-shadow:
    0 0 40px rgba(230,57,70,0.2),
    inset 0 0 30px rgba(230,57,70,0.08);
}

.hero-race::before {
  content: '';
  position: absolute;
  top: 50%;
  left: -20px;
  width: 18px;
  height: 2px;
  background: linear-gradient(90deg, transparent, rgba(230,57,70,0.6));
  transform: rotate(-12deg);
  opacity: 0;
  animation: crackAppear 0.2s ease 1.55s both;
}

.hero-race::after {
  content: '';
  position: absolute;
  top: 35%;
  right: -22px;
  width: 20px;
  height: 2px;
  background: linear-gradient(270deg, transparent, rgba(230,57,70,0.5));
  transform: rotate(15deg);
  opacity: 0;
  animation: crackAppear 0.2s ease 1.6s both;
}

.hero-race-wrap {
  position: relative;
  display: inline-block;
  vertical-align: baseline;
  margin-bottom: -12px;
  top: -8px;
}

.hero-subtitle {
  font-size: clamp(15px, 2vw, 19px);
  color: var(--text-secondary);
  text-align: center;
  max-width: 640px;
  margin-top: 28px;
  line-height: 1.7;
  animation: fadeIn 1s ease 1.2s both;
}

.hero-meta {
  display: flex;
  gap: 40px;
  margin-top: 30px;
  animation: fadeIn 1s ease 1.4s both;
}

.hero-stat { text-align: center; }

.hero-stat-num {
  font-family: 'Source Code Pro', monospace;
  font-size: 28px;
  font-weight: 600;
  color: var(--accent-cyan);
}

.hero-stat-label {
  font-size: 11px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 2px;
  margin-top: 4px;
}

.scroll-indicator {
  position: absolute;
  bottom: 40px;
  animation: fadeIn 1s ease 1.8s both, bounce 2s ease infinite 2.8s;
  cursor: pointer;
}

.scroll-indicator svg {
  width: 24px;
  height: 24px;
  stroke: var(--text-muted);
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes stampSlam {
  0% { 
    opacity: 0; 
    transform: scale(8) rotate(5deg); 
    filter: blur(4px);
  }
  60% { 
    opacity: 1; 
    transform: scale(0.9) rotate(-3.5deg); 
    filter: blur(0px);
  }
  75% { 
    transform: scale(1.05) rotate(-2deg);
  }
  100% { 
    opacity: 1; 
    transform: scale(1) rotate(-2.5deg); 
    filter: blur(0px);
  }
}

@keyframes screenShake {
  0% { transform: translate(0, 0); }
  15% { transform: translate(-3px, 2px); }
  30% { transform: translate(2px, -2px); }
  45% { transform: translate(-2px, 1px); }
  60% { transform: translate(1px, -1px); }
  75% { transform: translate(-1px, 0px); }
  100% { transform: translate(0, 0); }
}

@keyframes crackAppear {
  from { opacity: 0; width: 0; }
  to { opacity: 1; }
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(8px); }
}

/* ============ SCROLL REVEAL ANIMATIONS ============ */

/* Section navigation arrows */
.section-nav-arrow {
  display: flex;
  justify-content: center;
  margin-top: 20px;
  padding-bottom: 10px;
  flex-shrink: 0;
}

.section-nav-arrow a {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  border: 1px solid var(--border);
  border-radius: 50%;
  text-decoration: none;
  transition: all 0.3s ease;
  animation: bounce 2.5s ease infinite;
  cursor: pointer;
}

.section-nav-arrow a:hover {
  border-color: var(--accent-red);
  background: rgba(230,57,70,0.08);
}

.section-nav-arrow a svg {
  width: 18px;
  height: 18px;
  stroke: var(--text-muted);
  fill: none;
  stroke-width: 2;
  stroke-linecap: round;
  transition: stroke 0.3s ease;
}

.section-nav-arrow a:hover svg {
  stroke: var(--accent-red);
}

/* ============ SCROLL REVEAL ANIMATIONS ============ */
.reveal {
  opacity: 0;
  transform: translateY(40px);
  transition: opacity 0.9s cubic-bezier(0.16, 1, 0.3, 1), transform 0.9s cubic-bezier(0.16, 1, 0.3, 1);
}

.reveal.from-left {
  transform: translateX(-60px);
}

.reveal.from-right {
  transform: translateX(60px);
}

.reveal.scale-in {
  transform: scale(0.92);
}

.reveal.visible {
  opacity: 1;
  transform: translateY(0) translateX(0) scale(1);
}

.stagger-1 { transition-delay: 0.1s; }
.stagger-2 { transition-delay: 0.2s; }
.stagger-3 { transition-delay: 0.3s; }
.stagger-4 { transition-delay: 0.4s; }

/* ============ MAP SECTION ============ */
.map-section {
  padding: 20px 20px 20px;
  max-width: 1200px;
  margin: 0 auto;
  height: calc(100vh - 70px);
  height: calc(100dvh - 70px);
  display: flex;
  flex-direction: column;
  box-sizing: border-box;
}

.section-header {
  text-align: center;
  margin-bottom: 16px;
  flex-shrink: 0;
}

.section-label {
  font-family: 'Source Code Pro', monospace;
  font-size: 11px;
  letter-spacing: 4px;
  text-transform: uppercase;
  color: var(--accent-red);
  margin-bottom: 16px;
}

.section-title {
  font-family: 'Playfair Display', serif;
  font-size: clamp(28px, 4vw, 44px);
  font-weight: 700;
}

.section-desc {
  color: var(--text-secondary);
  margin-top: 16px;
  max-width: 720px;
  margin-left: auto;
  margin-right: auto;
  line-height: 1.6;
}

.map-container {
  position: relative;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  flex: 1;
  min-height: 0;
  overflow: visible;
}

.california-map {
  position: relative;
  width: 100%;
  max-width: 425px;
  max-height: 100%;
  aspect-ratio: 500 / 780;
}

.california-map svg {
  width: 100%;
  height: 100%;
  filter: drop-shadow(0 0 40px rgba(230,57,70,0.08));
}

.ca-outline {
  fill: rgba(230,57,70,0.04);
  stroke: rgba(230,57,70,0.3);
  stroke-width: 1.5;
  transition: fill 0.4s ease;
}

.ca-outline:hover {
  fill: rgba(230,57,70,0.07);
}

/* City markers */
/* City markers (SVG-native) */
.city-marker {
  cursor: pointer;
}

.dot-fill {
  fill: var(--accent-red);
  transition: r 0.3s ease;
}
.dot-fill.denied {
  fill: var(--text-muted);
}

.dot-pulse {
  fill: none;
  stroke: rgba(230,57,70,0.4);
  stroke-width: 1;
  animation: svg-pulse 2s ease infinite;
}
.dot-pulse.denied {
  stroke: rgba(85,85,106,0.3);
}

.city-marker:hover .dot-fill {
  r: 10;
  filter: drop-shadow(0 0 12px rgba(230,57,70,0.6));
}
.city-marker:hover .dot-fill.denied {
  filter: drop-shadow(0 0 12px rgba(85,85,106,0.5));
}

.dot-label {
  font-family: 'Source Code Pro', monospace;
  font-size: 10px;
  font-weight: 600;
  fill: var(--text-secondary);
  letter-spacing: 1.5px;
  text-transform: uppercase;
  transition: fill 0.3s ease;
  pointer-events: none;
}

.city-marker:hover .dot-label {
  fill: var(--text-primary);
}

@keyframes svg-pulse {
  0% { r: 13; opacity: 0.6; }
  100% { r: 18; opacity: 0; }
}

@keyframes pulse-ring {
  0% { transform: scale(1); opacity: 0.6; }
  100% { transform: scale(2.2); opacity: 0; }
}

/* Mobile map scaling */
@media (max-width: 540px) {
  .map-section {
    height: calc(100vh - 70px);
    height: calc(100dvh - 70px);
    padding-top: 16px;
    padding-bottom: 10px;
  }
  .map-section .section-header {
    margin-bottom: 0;
  }
  .map-section .section-label {
    margin-bottom: 6px;
  }
  .map-section .section-desc {
    margin-top: 6px;
  }
  .map-container {
    overflow: visible;
  }
  .section-nav-arrow {
    margin-top: 10px;
  }
  .dot-pulse {
    stroke-width: 2;
    stroke: rgba(230,57,70,0.7);
    animation: svg-pulse-mobile 1.5s ease infinite;
  }
  .dot-pulse.denied {
    stroke: rgba(85,85,106,0.5);
  }
  .audio-control {
    display: none;
  }
}

@keyframes svg-pulse-mobile {
  0% { r: 13; opacity: 0.8; }
  50% { opacity: 0.4; }
  100% { r: 26; opacity: 0; }
}

@media (min-width: 541px) and (max-width: 768px) {
  .map-section {
    height: calc(100vh - 70px);
    height: calc(100dvh - 70px);
  }
  .audio-control {
    display: none;
  }
}

/* Preview card */
.preview-card {
  position: fixed;
  width: 300px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  opacity: 0;
  pointer-events: none;
  transform: translateY(10px);
  transition: opacity 0.25s ease, transform 0.25s ease;
  z-index: 1000;
  box-shadow: 0 20px 60px rgba(0,0,0,0.6);
  max-height: 90vh;
  overflow-y: auto;
}

.preview-card.active {
  opacity: 1;
  pointer-events: auto;
  transform: translateY(0);
}

.preview-card-title {
  font-family: 'Playfair Display', serif;
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 4px;
}

.preview-card-period {
  font-family: 'Source Code Pro', monospace;
  font-size: 10px;
  color: var(--text-muted);
  letter-spacing: 1px;
  margin-bottom: 16px;
}

.preview-mini-chart {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-bottom: 14px;
}

.mini-stat {
  background: rgba(255,255,255,0.03);
  border-radius: 8px;
  padding: 8px;
  text-align: center;
}

.mini-stat-value {
  font-family: 'Source Code Pro', monospace;
  font-size: 18px;
  font-weight: 600;
  color: var(--accent-red);
}

.mini-stat-label {
  font-size: 9px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-top: 2px;
}

.preview-bar {
  height: 3px;
  background: rgba(255,255,255,0.05);
  border-radius: 2px;
  margin-bottom: 4px;
  overflow: hidden;
}

.preview-bar-label {
  font-size: 10px;
  color: var(--text-muted);
  display: flex;
  justify-content: space-between;
  margin-bottom: 3px;
}

.preview-bar-fill {
  height: 100%;
  border-radius: 2px;
  transition: width 0.6s ease;
}

.preview-cta {
  display: block;
  text-align: center;
  font-size: 11px;
  font-weight: 600;
  color: var(--accent-cyan);
  text-transform: uppercase;
  letter-spacing: 2px;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border);
}

.denied-stamp {
  font-family: 'Source Code Pro', monospace;
  font-size: 13px;
  font-weight: 600;
  color: var(--accent-red);
  text-align: center;
  padding: 16px;
  border: 2px dashed rgba(230,57,70,0.3);
  border-radius: 8px;
  margin: 10px 0;
  text-transform: uppercase;
  letter-spacing: 3px;
  transform: rotate(-2deg);
}

/* PRR Denied ribbon for cities with public data */
.prr-ribbon-wrap {
  position: relative;
  overflow: hidden;
  border-radius: 8px;
  margin-bottom: 20px;
}
.prr-ribbon {
  position: absolute;
  top: 22px;
  left: -42px;
  width: 200px;
  padding: 5px 0;
  background: #d4880e;
  color: #0a0c11;
  font-family: 'Source Code Pro', monospace;
  font-size: 8px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-align: center;
  text-transform: uppercase;
  transform: rotate(-35deg);
  box-shadow: 0 2px 10px rgba(212,136,14,0.4);
  z-index: 10;
  line-height: 1.4;
}
.prr-ribbon-sub {
  font-weight: 400;
  font-size: 6px;
  letter-spacing: 1px;
  opacity: 0.8;
  display: block;
}
.prr-source-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-family: 'Source Code Pro', monospace;
  font-size: 9px;
  font-weight: 600;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: #d4880e;
  background: rgba(212,136,14,0.08);
  border: 1px solid rgba(212,136,14,0.25);
  padding: 6px 14px;
  border-radius: 4px;
  margin-bottom: 12px;
}

/* ============ CITY DETAIL SECTION ============ */
.city-details {
  padding: 20px 20px;
  max-width: 1200px;
  margin: 0 auto;
}

.city-tabs {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-bottom: 40px;
  flex-wrap: wrap;
}

.city-tab {
  font-family: 'Source Code Pro', monospace;
  font-size: 12px;
  letter-spacing: 1px;
  padding: 10px 24px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
}

.city-tab:hover {
  border-color: var(--accent-red);
  color: var(--text-primary);
}

.city-tab.active {
  background: var(--accent-red);
  border-color: var(--accent-red);
  color: var(--white);
}

.detail-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
}

@media (max-width: 768px) {
  .detail-grid { grid-template-columns: 1fr; }
  .hero-meta { gap: 20px; }
  .hero-race { letter-spacing: 6px; margin: 0 4px; padding: 6px 16px; font-size: clamp(22px, 4.5vw, 40px); }
}

.crime-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  transition: border-color 0.3s ease, transform 0.3s ease;
  cursor: pointer;
  position: relative;
}

.crime-card::after {
  content: '▸ CLICK FOR FULL RACIAL BREAKDOWN';
  position: absolute;
  bottom: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
  font-family: 'Source Code Pro', monospace;
  font-size: 9px;
  letter-spacing: 1.2px;
  color: var(--accent-red);
  background: var(--bg-card);
  border: 1px solid rgba(230,57,70,0.3);
  border-radius: 4px;
  padding: 5px 12px;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.25s ease;
  z-index: 10;
}

.crime-card:hover::after {
  opacity: 1;
}

.crime-card:hover {
  border-color: rgba(230,57,70,0.4);
  transform: translateY(-3px);
}

.crime-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.crime-card-type {
  font-family: 'Source Code Pro', monospace;
  font-size: 11px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--accent-red);
}

.crime-card-total {
  font-family: 'Source Code Pro', monospace;
  font-size: 24px;
  font-weight: 600;
  color: var(--text-primary);
}

.crime-card-total span {
  font-size: 11px;
  color: var(--text-muted);
  font-weight: 400;
}

/* Pending / Coming Soon crime cards */
.crime-card-pending {
  background: var(--bg-card);
  border: 1px dashed var(--border);
  border-radius: 8px;
  padding: 24px;
  position: relative;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 220px;
}

.crime-card-pending::before {
  content: '';
  position: absolute;
  inset: 0;
  background: repeating-linear-gradient(
    -45deg,
    transparent,
    transparent 10px,
    rgba(230,57,70,0.03) 10px,
    rgba(230,57,70,0.03) 20px
  );
  pointer-events: none;
}

.pending-label {
  font-family: 'Playfair Display', serif;
  font-size: 18px;
  font-weight: 700;
  color: var(--text-secondary);
  margin-bottom: 12px;
}

.pending-badge {
  display: inline-block;
  font-family: 'Source Code Pro', monospace;
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--accent-red);
  border: 1px solid rgba(230,57,70,0.4);
  padding: 5px 16px;
  border-radius: 3px;
  background: rgba(230,57,70,0.06);
  transform: rotate(-2deg);
  animation: pendingPulse 3s ease-in-out infinite;
}

@keyframes pendingPulse {
  0%, 100% { opacity: 0.7; border-color: rgba(230,57,70,0.3); }
  50% { opacity: 1; border-color: rgba(230,57,70,0.6); }
}

.pending-note {
  font-family: 'Source Code Pro', monospace;
  font-size: 9px;
  color: var(--text-muted);
  margin-top: 14px;
  letter-spacing: 0.5px;
}

/* Typewriter date display */
.city-date-display {
  text-align: center;
  margin-top: -16px;
  margin-bottom: 0;
}

.city-date-label {
  font-family: 'Source Code Pro', monospace;
  font-size: 11px;
  color: var(--text-muted);
  letter-spacing: 1px;
  margin-bottom: 8px;
}

.city-date-value {
  display: inline-block;
  font-family: 'Source Code Pro', monospace;
  font-size: 18px;
  font-weight: 700;
  color: #fff;
  letter-spacing: 1.5px;
  border-right: 2px solid var(--accent-red);
  padding-right: 4px;
  overflow: hidden;
  white-space: nowrap;
  max-width: 0;
}

.city-date-value.typing {
  animation: typewriterReveal 1.5s steps(25) forwards, typewriterBlink 0.7s step-end infinite;
}

@keyframes typewriterReveal {
  from { max-width: 0; }
  to { max-width: 500px; }
}

@keyframes typewriterBlink {
  50% { border-color: transparent; }
}

.city-date-duration {
  display: inline-block;
  font-family: 'Source Code Pro', monospace;
  font-size: 13px;
  font-weight: 600;
  color: var(--accent-red);
  letter-spacing: 1.2px;
  border-right: 2px solid var(--accent-red);
  padding-right: 4px;
  overflow: hidden;
  white-space: nowrap;
  max-width: 0;
  margin-top: 6px;
  opacity: 0.85;
}

.city-date-duration.typing {
  animation: typewriterReveal 1.2s steps(20) forwards, typewriterBlink 0.7s step-end infinite;
}

/* Crime card date stamp */
.crime-card-period {
  font-family: 'Source Code Pro', monospace;
  font-size: 9px;
  font-weight: 600;
  color: var(--accent-red);
  letter-spacing: 0.8px;
  margin-top: 4px;
  opacity: 0.8;
  width: 100%;
}

.race-bars {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.race-bar-row {
  display: flex;
  align-items: center;
  gap: 8px;
}

.race-bar-label {
  font-size: 11px;
  color: var(--text-secondary);
  width: 55px;
  text-align: right;
  flex-shrink: 0;
}

.race-bar-track {
  flex: 1;
  height: 24px;
  background: rgba(255,255,255,0.04);
  border-radius: 4px;
  overflow: visible;
  position: relative;
}

.race-bar-fill {
  height: 100%;
  border-radius: 4px;
  display: flex;
  align-items: center;
  padding-left: 8px;
  font-family: 'Source Code Pro', monospace;
  font-size: 11px;
  color: rgba(255,255,255,0.9);
  font-weight: 600;
  transition: width 1s cubic-bezier(0.16, 1, 0.3, 1);
  overflow: visible;
  position: relative;
}

.race-bar-meta {
  font-family: 'Source Code Pro', monospace;
  font-size: 10px;
  color: var(--text-muted);
  width: 60px;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.race-bar-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
  padding-bottom: 6px;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.race-bar-header-spacer {
  width: 55px;
  flex-shrink: 0;
}

.race-bar-header-bar {
  flex: 1;
  font-family: 'Source Code Pro', monospace;
  font-size: 8px;
  color: var(--text-muted);
  letter-spacing: 1px;
  text-transform: uppercase;
}

.race-bar-header-meta {
  width: 60px;
  flex-shrink: 0;
  display: flex;
  justify-content: center;
  font-family: 'Source Code Pro', monospace;
  font-size: 8px;
  color: var(--text-muted);
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

/* ============ COUNT/PCT TOGGLE ============ */
.view-toggle {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-top: 12px;
  margin-bottom: 0;
}

.view-toggle-label {
  font-family: 'Source Code Pro', monospace;
  font-size: 9px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text-muted);
  transition: color 0.3s ease;
  cursor: pointer;
}

.view-toggle-label.active {
  color: var(--accent-red);
}

.view-toggle-switch {
  width: 36px;
  height: 18px;
  background: rgba(255,255,255,0.08);
  border: 1px solid var(--border);
  border-radius: 9px;
  position: relative;
  cursor: pointer;
  transition: all 0.3s ease;
}

.view-toggle-switch:hover {
  border-color: rgba(230,57,70,0.4);
}

.view-toggle-switch::after {
  content: '';
  position: absolute;
  top: 2px;
  left: 2px;
  width: 12px;
  height: 12px;
  background: var(--text-muted);
  border-radius: 50%;
  transition: all 0.3s ease;
}

.view-toggle-switch.on::after {
  left: 20px;
  background: var(--accent-red);
}

.view-toggle-switch.on {
  border-color: rgba(230,57,70,0.5);
  background: rgba(230,57,70,0.1);
}

.race-bar-fill-overflow {
  height: 100%;
  border-radius: 4px;
  display: flex;
  align-items: center;
  padding-left: 8px;
  font-family: 'Source Code Pro', monospace;
  font-size: 11px;
  color: rgba(255,255,255,0.9);
  font-weight: 600;
  min-width: fit-content;
  transition: width 1s cubic-bezier(0.16, 1, 0.3, 1);
  position: relative;
}

.bar-count-outside {
  position: absolute;
  left: calc(100% + 6px);
  white-space: nowrap;
  font-family: 'Source Code Pro', monospace;
  font-size: 11px;
  font-weight: 600;
  color: var(--text-secondary);
}

.disproportion-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-family: 'Source Code Pro', monospace;
  font-size: 10px;
  font-weight: 600;
  padding: 0 6px;
  border-radius: 4px;
  min-width: 36px;
  height: 24px;
}

.disproportion-badge.rank-high {
  background: rgba(230,57,70,0.2);
  color: var(--accent-red);
}

.disproportion-badge.rank-mid {
  background: rgba(232,133,58,0.2);
  color: var(--accent-gold);
}

.disproportion-badge.rank-low {
  background: rgba(39,174,96,0.2);
  color: #27ae60;
}

.source-link {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  margin-top: 20px;
  font-family: 'Source Code Pro', monospace;
  font-size: 11px;
  color: var(--accent-cyan);
  text-decoration: none;
  padding: 10px;
  border: 1px dashed rgba(0,212,255,0.2);
  border-radius: 6px;
  transition: all 0.3s ease;
}

.source-link:hover {
  background: rgba(0,212,255,0.05);
  border-color: rgba(0,212,255,0.4);
}

.source-report-row {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 16px;
  text-decoration: none;
  border-bottom: 1px solid rgba(255,255,255,0.04);
  transition: background 0.2s;
  -webkit-tap-highlight-color: rgba(0,212,255,0.1);
  touch-action: manipulation;
}

.source-report-row:hover,
.source-report-row:active {
  background: rgba(0,212,255,0.05);
}

/* ============ STATEWIDE SECTION ============ */
.statewide-section {
  padding: 20px 20px;
  position: relative;
}

.statewide-section::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(180deg, transparent 0%, rgba(230,57,70,0.015) 30%, rgba(230,57,70,0.015) 70%, transparent 100%);
  pointer-events: none;
}

.statewide-inner {
  max-width: 1200px;
  margin: 0 auto;
  position: relative;
}

/* Statewide view toggle */
.state-toggle-btn {
  font-family: 'Source Code Pro', monospace;
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text-muted);
  background: rgba(255,255,255,0.04);
  border: 1px solid var(--border);
  padding: 8px 20px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.state-toggle-btn:first-child {
  border-radius: 4px 0 0 4px;
}

.state-toggle-btn:last-child {
  border-radius: 0 4px 4px 0;
}

.state-toggle-btn:not(:first-child) {
  border-left: none;
}

.state-toggle-btn:not(:first-child).active {
  border-left: 1px solid rgba(230,57,70,0.4);
}

.state-toggle-btn:hover {
  color: var(--text-primary);
  background: rgba(255,255,255,0.06);
}

.state-toggle-btn.active {
  color: var(--accent-red);
  background: rgba(230,57,70,0.1);
  border-color: rgba(230,57,70,0.4);
}

.state-toggle-btn.active + .state-toggle-btn {
  border-left-color: rgba(230,57,70,0.4);
}

.statewide-year-badge.slammed {
  animation: stampSlam 0.5s cubic-bezier(0.22, 0.68, 0.35, 1.2) forwards;
}

/* Line charts */
.trend-charts {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 24px;
  margin-top: 40px;
}

@media (max-width: 800px) {
  .trend-charts { grid-template-columns: 1fr; }
}

.trend-chart-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  transition: all 0.3s ease;
  position: relative;
}

.trend-chart-card:hover {
  border-color: rgba(230,57,70,0.4);
  transform: translateY(-3px);
  box-shadow: 0 4px 20px rgba(230,57,70,0.08);
}

.trend-chart-title {
  font-family: 'Source Code Pro', monospace;
  font-size: 12px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--accent-red);
  margin-bottom: 6px;
}

.trend-chart-subtitle {
  font-size: 11px;
  color: var(--text-muted);
  margin-bottom: 16px;
}

.trend-svg {
  width: 100%;
  height: 200px;
}

.trend-svg .trend-dot {
  cursor: pointer;
  transition: r 0.15s ease;
}

.trend-svg .trend-dot:hover {
  r: 5;
  opacity: 1;
}

.trend-tooltip {
  position: fixed;
  pointer-events: none;
  background: rgba(15,18,25,0.95);
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: 6px;
  padding: 6px 10px;
  font-family: 'Source Code Pro', monospace;
  font-size: 11px;
  color: #fff;
  z-index: 9999;
  white-space: nowrap;
  max-width: calc(100vw - 16px);
  opacity: 0;
  transition: opacity 0.15s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,0.5);
}

.trend-tooltip.visible {
  opacity: 1;
}

.trend-tooltip .tt-race {
  font-weight: 700;
}

.trend-tooltip .tt-val {
  font-weight: 700;
  color: #fff;
}

.trend-tooltip .tt-year {
  color: var(--text-muted);
  margin-left: 4px;
}

.trend-legend {
  display: flex;
  gap: 14px;
  margin-top: 12px;
  flex-wrap: wrap;
}

.trend-legend-item {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 10px;
  color: var(--text-muted);
}

.trend-legend-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}

/* Population vs Arrest comparison */
.comparison-section {
  margin-top: 50px;
}

.comparison-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  margin-top: 30px;
  max-width: 900px;
  margin-left: auto;
  margin-right: auto;
}

@media (max-width: 540px) {
  .comparison-grid { grid-template-columns: 1fr; }
  .modal-content { padding: 24px 16px; }
  .modal-title { font-size: 20px; }
  .preview-card { display: none; }
  .hero-meta { flex-direction: row; gap: 24px; align-items: center; margin-top: 20px; }
  .hero-stat-num { font-size: 22px; }
  .hero-stat-label { font-size: 9px; letter-spacing: 1.5px; }
  .hero-subtitle { margin-top: 18px; }
  .scroll-indicator { bottom: 24px; }
  .statewide-section { padding: 16px 12px; }
  .city-details { padding: 16px 12px; }
  .transparency-section { padding: 16px 12px; }
}

.comparison-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 28px;
  transition: all 0.3s ease;
  cursor: default;
}

.comparison-card:hover {
  border-color: rgba(230,57,70,0.4);
  transform: translateY(-3px);
  box-shadow: 0 4px 20px rgba(230,57,70,0.08);
}

.comparison-card-title {
  font-family: 'Source Code Pro', monospace;
  font-size: 13px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--accent-red);
  text-align: center;
  margin-bottom: 20px;
}

.comparison-row {
  margin-bottom: 18px;
}

.comparison-row-label {
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 8px;
}

.comparison-bar-pair {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.comparison-bar-wrapper {
  display: flex;
  align-items: center;
  gap: 8px;
}

.comparison-bar-tag {
  font-family: 'Source Code Pro', monospace;
  font-size: 9px;
  color: var(--text-muted);
  width: 28px;
  text-align: right;
  flex-shrink: 0;
  text-transform: uppercase;
}

.comparison-bar-track {
  flex: 1;
  height: 18px;
  background: rgba(255,255,255,0.04);
  border-radius: 3px;
  overflow: visible;
  position: relative;
}

.comparison-bar-fill {
  height: 100%;
  border-radius: 3px;
  display: flex;
  align-items: center;
  padding-right: 6px;
  font-family: 'Source Code Pro', monospace;
  font-size: 10px;
  color: rgba(255,255,255,0.9);
  font-weight: 700;
  transition: width 1.2s cubic-bezier(0.16, 1, 0.3, 1);
  position: relative;
  overflow: visible;
}

.comparison-bar-fill .bar-pct-inside {
  position: absolute;
  right: 6px;
  white-space: nowrap;
  color: #fff;
  font-weight: 700;
}

.comparison-bar-fill .bar-pct-outside {
  position: absolute;
  left: calc(100% + 4px);
  white-space: nowrap;
  color: #fff;
  font-size: 9px;
  font-weight: 700;
}

.comparison-bar-fill.pop-bar {
  background-image: repeating-linear-gradient(
    45deg,
    transparent,
    transparent 2px,
    rgba(0,0,0,0.4) 2px,
    rgba(0,0,0,0.4) 4px
  );
}

.comparison-delta {
  font-family: 'Source Code Pro', monospace;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.5px;
  text-align: right;
  margin-top: 4px;
}

.comparison-delta.over { color: var(--accent-red); }
.comparison-delta.under { color: #27ae60; }

/* ============ TRANSPARENCY SECTION ============ */
.transparency-section {
  padding: 20px 20px;
  max-width: 1200px;
  margin: 0 auto;
}

.transparency-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 12px;
  margin-top: 40px;
}

.transparency-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 18px;
  display: flex;
  align-items: center;
  gap: 14px;
  transition: all 0.3s ease;
}

.transparency-card:hover {
  border-color: rgba(255,255,255,0.1);
}

.transparency-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}

.transparency-dot.provided { background: #27ae60; }
.transparency-dot.denied { background: var(--accent-red); }
.transparency-dot.partial { background: #f39c12; }
.transparency-dot.public { background: #d4880e; }

.transparency-city {
  font-size: 13px;
  font-weight: 600;
}

.transparency-status {
  font-family: 'Source Code Pro', monospace;
  font-size: 9px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* ============ METHODOLOGY ============ */
.methodology-section {
  padding: 20px 20px;
  background: rgba(255,255,255,0.01);
}

.methodology-inner {
  max-width: 720px;
  margin: 0 auto;
}

.methodology-text {
  color: var(--text-secondary);
  line-height: 1.9;
  font-size: 15px;
}

.methodology-text strong {
  color: var(--text-primary);
}

/* ============ FOOTER ============ */
.footer {
  padding: 60px 20px;
  text-align: center;
  border-top: 1px solid var(--border);
}

.footer-text {
  font-size: 12px;
  color: var(--text-muted);
  line-height: 1.8;
}

.footer-text a {
  color: var(--accent-cyan);
  text-decoration: none;
}

/* ============ MODAL ============ */
.modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.88);
  z-index: 1000;
  display: none;
  justify-content: center;
  align-items: flex-start;
  padding: 40px 20px;
  overflow-y: auto;
  backdrop-filter: blur(10px);
}

.modal-overlay.active { display: flex; }

.modal-scroll-hint {
  position: sticky;
  bottom: 0;
  left: 0;
  right: 0;
  display: none;
  justify-content: center;
  padding: 20px 0 12px;
  background: linear-gradient(transparent, var(--bg-primary) 30%);
  pointer-events: none;
  transition: opacity 0.4s ease;
  z-index: 5;
}

.modal-scroll-hint span {
  font-family: 'Source Code Pro', monospace;
  font-size: 12px;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: #fff;
  background: rgba(230,57,70,0.25);
  border: 1px solid rgba(230,57,70,0.5);
  padding: 8px 20px;
  border-radius: 20px;
  animation: scrollBounce 1.5s ease-in-out infinite;
}

@keyframes scrollBounce {
  0%, 100% { transform: translateY(0); opacity: 0.7; }
  30% { transform: translateY(-8px); opacity: 1; }
  50% { transform: translateY(2px); opacity: 1; }
  70% { transform: translateY(-4px); opacity: 1; }
}

@media (max-width: 768px) {
  .modal-scroll-hint { display: flex; }
}

.modal-content {
  background: var(--bg-primary);
  border: 1px solid var(--border);
  border-radius: 16px;
  max-width: 900px;
  width: 100%;
  padding: 40px;
  position: relative;
  animation: modalIn 0.35s cubic-bezier(0.16, 1, 0.3, 1);
}

@keyframes modalIn {
  from { opacity: 0; transform: translateY(30px) scale(0.97); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.modal-close {
  position: absolute;
  top: 20px; right: 20px;
  width: 36px; height: 36px;
  border: 1px solid var(--border);
  border-radius: 50%;
  background: transparent;
  color: var(--text-secondary);
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.modal-close:hover {
  border-color: var(--accent-red);
  color: var(--accent-red);
}

.modal-title {
  font-family: 'Playfair Display', serif;
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 6px;
}

.modal-subtitle {
  font-family: 'Source Code Pro', monospace;
  font-size: 11px;
  color: var(--text-muted);
  letter-spacing: 2px;
  text-transform: uppercase;
  margin-bottom: 30px;
}

.modal-chart-area {
  background: var(--bg-card);
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 24px;
}

.modal-bar-group-label {
  font-family: 'Source Code Pro', monospace;
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 6px;
  letter-spacing: 1px;
}

.modal-bar-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 4px;
}

.modal-bar-name {
  font-size: 11px;
  color: var(--text-secondary);
  width: 115px;
  text-align: right;
  flex-shrink: 0;
}

.modal-bar-track {
  flex: 1;
  height: 26px;
  background: rgba(255,255,255,0.04);
  border-radius: 4px;
  overflow: visible;
  position: relative;
}

.modal-bar-fill {
  height: 100%;
  border-radius: 4px;
  display: flex;
  align-items: center;
  padding-left: 8px;
  font-family: 'Source Code Pro', monospace;
  font-size: 11px;
  color: rgba(255,255,255,0.9);
  font-weight: 600;
  overflow: visible;
  position: relative;
  transition: width 0.8s cubic-bezier(0.16, 1, 0.3, 1);
}

.modal-bar-value {
  font-family: 'Source Code Pro', monospace;
  font-size: 11px;
  color: var(--text-muted);
  width: 45px;
  flex-shrink: 0;
}

.modal-insight-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 14px;
}

.modal-insight {
  background: var(--bg-card);
  border-radius: 10px;
  padding: 16px;
  text-align: center;
}

.modal-insight-num {
  font-family: 'Source Code Pro', monospace;
  font-size: 24px;
  font-weight: 600;
}

.modal-insight-label {
  font-size: 10px;
  color: var(--text-muted);
  margin-top: 4px;
}

/* Typewriter cursor for section reveals */
.typewriter-cursor {
  display: inline-block;
  width: 2px;
  height: 1em;
  background: var(--accent-red);
  animation: blink 1s step-end infinite;
  vertical-align: text-bottom;
  margin-left: 4px;
}

@keyframes blink {
  50% { opacity: 0; }
}
/* ============ RAIN EFFECT ============ */
#rainCanvas {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 1;
  opacity: 0.35;
  transition: opacity 0.3s ease;
}

/* ============ WET SURFACE REFLECTIONS ============ */
.section-divider::before {
  content: '';
  position: absolute;
  bottom: 0;
  left: 10%;
  right: 10%;
  height: 40px;
  background: linear-gradient(180deg, 
    rgba(230,57,70,0.04) 0%, 
    rgba(230,57,70,0.02) 30%,
    transparent 100%
  );
  filter: blur(8px);
  opacity: 0;
  transition: opacity 1.2s ease 0.6s;
}

.section-divider::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 5%;
  right: 5%;
  height: 1px;
  background: linear-gradient(90deg, 
    transparent 0%, 
    rgba(230,57,70,0.08) 15%,
    rgba(0,212,255,0.05) 35%,
    transparent 50%,
    rgba(230,57,70,0.06) 65%,
    rgba(0,212,255,0.04) 85%,
    transparent 100%
  );
  animation: wetShimmer 8s ease-in-out infinite;
  opacity: 0;
  transition: opacity 1.2s ease 0.8s;
}

.section-divider:has(.visible)::before,
.section-divider:has(.visible)::after {
  opacity: 1;
}

@keyframes wetShimmer {
  0%, 100% { transform: translateX(-5%); opacity: 0.6; }
  50% { transform: translateX(5%); opacity: 1; }
}

</style>
</head>
<body>
<div class="grain"></div>
<div class="scanlines"></div>
<canvas id="rainCanvas"></canvas>

<!-- AUDIO CONTROL -->
<div class="audio-control" id="audioControl" onclick="toggleAudio()" title="Toggle ambient audio">
  <div class="audio-bars">
    <div class="audio-bar playing"></div>
    <div class="audio-bar playing"></div>
    <div class="audio-bar playing"></div>
    <div class="audio-bar playing"></div>
  </div>
</div>

<!-- NAVIGATION -->
<nav class="nav" id="nav">
  <div class="nav-logo">CA Crime Data</div>
  <div class="nav-links">
    <a onclick="document.getElementById('map').scrollIntoView({behavior:'smooth'})">Map</a>
    <a onclick="document.getElementById('cities').scrollIntoView({behavior:'smooth'})">Cities</a>
    <a onclick="document.getElementById('statewide').scrollIntoView({behavior:'smooth'})">Statewide</a>
    <a onclick="document.getElementById('transparency').scrollIntoView({behavior:'smooth'})">Transparency</a>
  </div>
</nav>

<!-- HERO -->
<section class="hero" id="hero">
  <div class="hero-fog">
    <div class="fog-layer"></div>
    <div class="fog-layer"></div>
  </div>
  <div class="hero-badge">Public Records Request Investigation</div>
  <h1 class="hero-title">California
    <span class="hero-race-wrap">
      <span class="hero-race">RACE</span>
    </span>
    Crime<br>
    <em>By the Numbers</em></h1>
  <p class="hero-subtitle">An independent investigation using public records requests to examine arrest data for homicide, sexual assault, kidnapping, and robbery across California's and its major cities.</p>
  <div class="hero-meta">
    <div class="hero-stat">
      <div class="hero-stat-num" id="counterYears">0</div>
      <div class="hero-stat-label">Years of Data</div>
    </div>
    <div class="hero-stat">
      <div class="hero-stat-num" id="counterCrimes">0</div>
      <div class="hero-stat-label">Crime Types</div>
    </div>
    <div class="hero-stat">
      <div class="hero-stat-num" id="counterCities">0</div>
      <div class="hero-stat-label">Cities Requested</div>
    </div>
  </div>
  <div class="scroll-indicator" onclick="document.getElementById('map').scrollIntoView({behavior:'smooth'})">
    <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><path d="M12 5v14M19 12l-7 7-7-7"/></svg>
  </div>
</section>

<!-- DIVIDER -->
<div class="section-divider">
  <div class="divider-line reveal"></div>
  <div class="divider-text reveal">Explore the Data</div>
</div>

<!-- MAP SECTION -->
<section class="map-section" id="map">
  <div class="section-header reveal">
    <div class="section-label">Interactive Map</div>
    <div class="section-title">Explore by City</div>
    <div class="section-desc">Hover over a city to preview its data. Red = records provided. Gray = denied or no response.</div>
  </div>

  <div class="map-container reveal scale-in">
    <div class="california-map">
      <!-- Real California outline from US Census GeoJSON data -->
      <svg viewBox="0 0 500 780" xmlns="http://www.w3.org/2000/svg" overflow="visible">
        <path class="ca-outline" d="M 72.7 146.4 L 111.0 146.1 L 171.0 146.9 L 217.4 146.9 L 217.6 236.0 L 217.4 301.2 L 275.0 347.4 L 329.4 392.8 L 372.4 429.8 L 403.3 457.1 L 457.7 507.0 L 457.7 513.5 L 465.0 522.0 L 471.2 535.5 L 480.0 542.8 L 474.6 549.6 L 467.5 553.0 L 462.1 562.0 L 463.8 574.1 L 462.6 581.7 L 453.5 589.1 L 456.5 608.3 L 462.6 608.5 L 465.0 618.1 L 462.6 622.6 L 453.8 624.6 L 394.4 629.4 L 346.1 633.9 L 340.7 627.1 L 340.5 616.4 L 337.0 603.7 L 330.7 594.7 L 316.7 582.3 L 298.8 570.8 L 295.4 573.9 L 288.5 571.9 L 289.5 566.8 L 281.6 556.4 L 271.1 558.6 L 252.5 551.0 L 249.8 544.8 L 237.2 537.2 L 223.0 537.5 L 211.3 534.1 L 196.3 535.5 L 188.5 528.7 L 190.2 514.4 L 187.5 512.1 L 189.2 501.9 L 177.4 494.3 L 176.9 483.9 L 172.5 483.3 L 165.2 474.3 L 160.0 472.3 L 157.8 466.7 L 140.6 445.6 L 132.5 439.3 L 130.8 422.7 L 134.3 424.1 L 137.5 414.3 L 131.1 405.2 L 123.2 406.4 L 112.9 398.2 L 109.3 391.7 L 110.0 385.5 L 104.8 377.3 L 104.8 363.8 L 113.2 363.8 L 109.7 344.9 L 106.1 346.9 L 105.3 356.2 L 96.5 358.1 L 86.0 351.1 L 84.2 339.0 L 77.4 329.4 L 68.3 323.5 L 63.4 316.7 L 50.2 303.4 L 52.4 299.5 L 46.2 282.3 L 48.9 272.7 L 45.0 258.3 L 33.5 244.2 L 22.2 236.3 L 20.0 227.0 L 31.3 204.5 L 33.5 196.8 L 31.3 190.9 L 35.4 175.4 L 31.8 161.3 L 26.9 157.9 L 28.8 146.6 Z"/>

        <!-- City markers inside SVG coordinate space -->
        <!-- Sacramento: inland Central Valley, NE of Bay Area -->
        <g class="city-marker" data-city="sacramento" onmouseenter="showPreview('sacramento', event)" onmouseleave="hidePreview()" style="cursor:pointer">
          <circle class="dot-pulse" cx="168" cy="305" r="13"/>
          <circle class="dot-fill" cx="168" cy="305" r="7"/>
          <text class="dot-label" x="184" y="310" text-anchor="start">Sacramento</text>
        </g>

        <!-- Oakland: east side of SF Bay, clearly inland -->
        <g class="city-marker" data-city="oakland" onmouseenter="showPreview('oakland', event)" onmouseleave="hidePreview()" style="cursor:pointer">
          <circle class="dot-pulse" cx="130" cy="355" r="13"/>
          <circle class="dot-fill" cx="130" cy="355" r="7"/>
          <text class="dot-label" x="114" y="349" text-anchor="end">Oakland</text>
        </g>

        <!-- San Francisco: on the peninsula, at the coast -->
        <g class="city-marker" data-city="san_francisco" onmouseenter="showPreview('san_francisco', event)" onmouseleave="hidePreview()" style="cursor:pointer">
          <circle class="dot-pulse" cx="115" cy="370" r="13"/>
          <circle class="dot-fill" cx="115" cy="370" r="7"/>
          <text class="dot-label" x="99" y="380" text-anchor="end">San Francisco</text>
        </g>

        <!-- San Jose: south end of SF Bay, inland -->
        <g class="city-marker" data-city="san_jose" onmouseenter="showPreview('san_jose', event)" onmouseleave="hidePreview()" style="cursor:pointer">
          <circle class="dot-pulse" cx="140" cy="400" r="13"/>
          <circle class="dot-fill" cx="140" cy="400" r="7"/>
          <text class="dot-label" x="156" y="405" text-anchor="start">San José</text>
        </g>

        <!-- Fresno: Central Valley, south of Sacramento -->
        <g class="city-marker" data-city="fresno" onmouseenter="showPreview('fresno', event)" onmouseleave="hidePreview()" style="cursor:pointer">
          <circle class="dot-pulse denied" cx="235" cy="435" r="13"/>
          <circle class="dot-fill denied" cx="235" cy="435" r="7"/>
          <text class="dot-label" x="251" y="440" text-anchor="start">Fresno</text>
        </g>

        <!-- Bakersfield: southern Central Valley -->
        <g class="city-marker" data-city="bakersfield" onmouseenter="showPreview('bakersfield', event)" onmouseleave="hidePreview()" style="cursor:pointer">
          <circle class="dot-pulse denied" cx="280" cy="500" r="13"/>
          <circle class="dot-fill denied" cx="280" cy="500" r="7"/>
          <text class="dot-label" x="296" y="505" text-anchor="start">Bakersfield</text>
        </g>

        <!-- Los Angeles: SoCal coast -->
        <g class="city-marker" data-city="los_angeles" onmouseenter="showPreview('los_angeles', event)" onmouseleave="hidePreview()" style="cursor:pointer">
          <circle class="dot-pulse denied" cx="310" cy="558" r="13"/>
          <circle class="dot-fill denied" cx="310" cy="558" r="7"/>
          <text class="dot-label" x="326" y="553" text-anchor="start">Los Angeles</text>
        </g>

        <!-- Anaheim: inland SE of LA -->
        <g class="city-marker" data-city="anaheim" onmouseenter="showPreview('anaheim', event)" onmouseleave="hidePreview()" style="cursor:pointer">
          <circle class="dot-pulse denied" cx="328" cy="572" r="13"/>
          <circle class="dot-fill denied" cx="328" cy="572" r="7"/>
          <text class="dot-label" x="344" y="577" text-anchor="start">Anaheim</text>
        </g>

        <!-- Long Beach: coast, south of LA -->
        <g class="city-marker" data-city="long_beach" onmouseenter="showPreview('long_beach', event)" onmouseleave="hidePreview()" style="cursor:pointer">
          <circle class="dot-pulse denied" cx="305" cy="575" r="13"/>
          <circle class="dot-fill denied" cx="305" cy="575" r="7"/>
          <text class="dot-label" x="289" y="580" text-anchor="end">Long Beach</text>
        </g>

        <!-- San Diego: SW corner, above the Mexico border -->
        <g class="city-marker" data-city="san_diego" onmouseenter="showPreview('san_diego', event)" onmouseleave="hidePreview()" style="cursor:pointer">
          <circle class="dot-pulse denied" cx="345" cy="620" r="13"/>
          <circle class="dot-fill denied" cx="345" cy="620" r="7"/>
          <text class="dot-label" x="361" y="625" text-anchor="start">San Diego</text>
        </g>
      </svg>
    </div>

    </div>
  </div>
  <div class="section-nav-arrow"><a onclick="document.getElementById('cities').scrollIntoView({behavior:'smooth'})"><svg viewBox="0 0 24 24"><path d="M12 5v14M19 12l-7 7-7-7"/></svg></a></div>
</section>

<!-- DIVIDER -->
<div class="section-divider">
  <div class="divider-line reveal"></div>
  <div class="divider-text reveal">City-Level Data</div>
</div>

<!-- CITY DETAIL SECTION -->
<section class="city-details" id="cities">
  <div class="section-header reveal">
    <div class="section-label">City Breakdowns</div>
    <div class="section-title">Arrest & Suspect Data</div>
    <div class="section-desc">Click any card for the full breakdown. Source data links included for every dataset.</div>
  </div>

  <div class="city-tabs reveal">
    <button class="city-tab active" onclick="switchCity('sacramento')">Sacramento</button>
    <button class="city-tab" onclick="switchCity('san_jose')">San José</button>
    <button class="city-tab" onclick="switchCity('san_francisco')">San Francisco</button>
    <button class="city-tab" onclick="switchCity('oakland')">Oakland</button>
  </div>

  <div id="cityDetailContent" class="reveal"></div>
  <div class="section-nav-arrow"><a onclick="document.getElementById('statewide').scrollIntoView({behavior:'smooth'})"><svg viewBox="0 0 24 24"><path d="M12 5v14M19 12l-7 7-7-7"/></svg></a></div>
</section>

<!-- DIVIDER -->
<div class="section-divider">
  <div class="divider-line reveal"></div>
  <div class="divider-text reveal">Statewide Analysis</div>
</div>

<!-- STATEWIDE SECTION -->
<section class="statewide-section" id="statewide">
  <div class="statewide-inner">
    <div class="section-header reveal">
      <div class="section-label">California Attorney General Data</div>
      <div class="section-title">Statewide Felony Arrests</div>
      <div style="display:flex; justify-content:center; margin-bottom:12px;">
        <div class="statewide-year-badge" style="display:inline-block; font-family:'Source Code Pro',monospace; font-size:11px; font-weight:700; color:#fff; background:var(--accent-red); padding:4px 14px; border-radius:3px; letter-spacing:1.5px; transform:rotate(-2deg) scale(0); box-shadow:0 2px 8px rgba(230,57,70,0.3); opacity:0;">2000 – 2024</div>
      </div>
      <div style="display:flex; justify-content:center; margin-bottom:8px;">
        <div class="city-date-duration" id="statewideDurationTypewriter" style="font-size:12px;">24 years of data</div>
      </div>
      <div class="statewide-toggle" style="display: flex; justify-content: center; gap: 0; margin-top: 16px;">
        <button class="state-toggle-btn active" data-mode="counts" onclick="switchStatewideView('counts')">Counts</button>
        <button class="state-toggle-btn" data-mode="rate" onclick="switchStatewideView('rate')">Rate</button>
      </div>
    </div>

    <!-- Trend line charts -->
    <div class="trend-charts" id="trendCharts"></div>

    <!-- Pop vs Arrest comparison -->
    <div class="comparison-section reveal" id="statewideComparison">
      <div class="section-header" style="margin-bottom: 20px;">
        <div class="section-label">Disproportionality</div>
        <div class="section-title" style="font-size: clamp(22px, 3vw, 32px);">Average Population Share vs. Average Arrest Share</div>
        <div class="section-desc">24-year averages (2000–2024).</div>
      </div>
      <div class="comparison-grid" id="comparisonGrid"></div>
    </div>

    <!-- Link to full CA data -->
    <div class="reveal" style="margin-top: 40px; text-align: center;">
      <a href="#" onclick="openSourcesModal(); return false;" class="source-link" style="display: inline-flex; max-width: 500px;">
        📄 View All CA Attorney General Source Reports (2000–2024) →
      </a>
    </div>
    <div class="section-nav-arrow"><a onclick="document.getElementById('transparency').scrollIntoView({behavior:'smooth'})"><svg viewBox="0 0 24 24"><path d="M12 5v14M19 12l-7 7-7-7"/></svg></a></div>
  </div>
</section>

<!-- DIVIDER -->
<div class="section-divider">
  <div class="divider-line reveal"></div>
  <div class="divider-text reveal">Accountability</div>
</div>

<!-- TRANSPARENCY SCORECARD -->
<section class="transparency-section" id="transparency">
  <div class="section-header reveal">
    <div class="section-label">Transparency Scorecard</div>
    <div class="section-title">Who Gave Up the Data?</div>
    <div class="section-desc">Which California cities complied with public records requests — and which ones didn't.</div>
  </div>

  <div class="transparency-grid reveal" id="transparencyGrid"></div>
</section>

<!-- METHODOLOGY -->
<section class="methodology-section">
  <div class="methodology-inner reveal">
    <div class="section-header" style="margin-bottom: 30px;">
      <div class="section-title">About This Data</div>
    </div>

    <div class="methodology-text">
      <div style="font-family: 'Source Code Pro', monospace; font-size: 13px; letter-spacing: 3px; text-transform: uppercase; color: var(--accent-red); margin-bottom: 16px;">Methodology</div>
      <strong>City-level data</strong> was obtained through formal public records requests (PRAs) filed directly with each city's police department. Requests asked for arrest or suspect data broken down by suspect race and victim race for four violent felony categories: homicide, sexual assault/rape, kidnapping, and robbery.<br><br>
      <strong>Statewide data</strong> comes from the California Attorney General's annual "Crime in California" reports, specifically Table 31 (Felony Arrests). These are published by the CA Department of Justice's OpenJustice portal.<br><br>
      <strong>Population data</strong> is sourced from U.S. Census Bureau estimates. Statewide demographics shifted significantly over the 24-year period (White: ~47% → ~34%, Hispanic: ~32% → ~40%, Black: ~6.5% → ~5.4%).<br><br>
      <strong>Per capita rates</strong> are calculated by dividing each group's share of arrests by their share of the population. 1.0x = proportional; above = overrepresented; below = underrepresented.<br><br>
      <strong>All source data</strong> — including the actual public records request documents, police department response files, and links to California Attorney General reports — are linked throughout this site. Nothing is hidden.
    </div>

    <div class="methodology-text" style="margin-top: 32px; padding-top: 28px; border-top: 1px solid var(--border);">
      <div style="font-family: 'Source Code Pro', monospace; font-size: 13px; letter-spacing: 3px; text-transform: uppercase; color: var(--accent-red); margin-bottom: 16px;">Limitations</div>
      <strong>City selection:</strong> Public records requests were submitted to California's 10 most populous cities. Response timelines and cooperation varied significantly — some departments responded within weeks, others took months of follow-up, and several denied requests or never responded. The cities represented here are those that provided usable data, not a curated sample.<br><br>
      <strong>Date ranges:</strong> Data periods are not uniform across cities. Some departments allow requests spanning many years, while others limit the scope to avoid overloading the caseworker assigned to process the request. As a result, Sacramento's data spans 2016–2024, while San José and San Francisco cover shorter windows (2020–2025 and 2020–2024, respectively), and Oakland covers 2020–2024. Direct city-to-city comparisons should account for these differences.<br><br>
      <strong>Racial categories:</strong> Race categories are reported as recorded by each police department. Different agencies use different classification systems — Sacramento uses "Other" as a catch-all fourth category, while San José, San Francisco, and Oakland report "Asian" as a distinct category. These are not directly equivalent.<br><br>
      <strong>2001 data excluded:</strong> The year 2001 is excluded from the statewide dataset. The California Attorney General's office published the same data for both the 2001 and 2002 reports — the 2001 "Crime in California" report contains identical figures to 2002, meaning the actual 2001 arrest data was never published. Because no valid data exists for that year, 2001 has been omitted. The statewide analysis covers 24 years: 2000, then 2002–2024.
    </div>
  </div>
</section>

<!-- FOOTER -->
<footer class="footer">
  <div class="footer-text">
    California Race Crime — Independent Public Records Investigation<br>
    Data sourced from police department PRAs and CA Attorney General reports<br>
    All source data available for public review
  </div>
</footer>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
  <div class="modal-content" id="modalContent" onclick="event.stopPropagation()">
    <button class="modal-close" onclick="closeModal()">&times;</button>
    <div id="modalInner"></div>
    <div class="modal-scroll-hint" id="modalScrollHint"><span>↓ scroll for more ↓</span></div>
  </div>
</div>

<!-- Preview card - MUST be a direct child of body, outside any transform containers -->
<div class="preview-card" id="previewCard"></div>

<script>
// ==================== DATA ====================
const cityData = {
  sacramento: {
    name: "Sacramento",
    period: "Jan 2016 – Mar 2024",
    duration: "8 years, 3 months of data",
    dataType: "Arrests",
    population: { Black: 13.2, Hispanic: 28.8, White: 34.8, Other: 21.3 },
    source: "Sacramento PD Public Records Request",
    sourceLink: "https://drive.google.com/drive/folders/1bBXoKALoFmXYnOmREvXyQblpyhbsDyAI?usp=share_link",
    crimes: {
      homicide: {
        label: "Homicide",
        total: 704,
        byRace: { Black: 399, Hispanic: 111, White: 59, Other: 135 },
        pcts: { Black: 56.7, Hispanic: 15.8, White: 8.4, Other: 19.2 },
        overrep: { Black: 4.3, Hispanic: 0.5, White: 0.2, Other: 0.9 },
        details: {
          Black: { Black: 266, White: 52, Hispanic: 53, Other: 28 },
          Hispanic: { Hispanic: 58, White: 23, Black: 29, Other: 1 },
          White: { White: 25, Black: 11, Hispanic: 19, Other: 4 },
          Other: { Other: 23, Black: 51, White: 30, Hispanic: 31 }
        }
      },
      sexual_assault: {
        label: "Sexual Assault",
        total: 4177,
        byRace: { Black: 1673, Hispanic: 1016, White: 1003, Other: 485 },
        pcts: { Black: 40.1, Hispanic: 24.3, White: 24.0, Other: 11.6 },
        overrep: { Black: 3.0, Hispanic: 0.8, White: 0.7, Other: 0.5 },
        details: {
          Black: { Black: 793, White: 553, Hispanic: 210, Other: 117 },
          Hispanic: { Hispanic: 607, White: 275, Black: 84, Other: 50 },
          White: { White: 618, Black: 117, Hispanic: 191, Other: 77 },
          Other: { Other: 220, White: 172, Black: 35, Hispanic: 58 }
        }
      },
      robbery: {
        label: "Robbery",
        total: 22338,
        byRace: { Black: 14202, Hispanic: 3262, White: 2837, Other: 2037 },
        pcts: { Black: 63.6, Hispanic: 14.6, White: 12.7, Other: 9.1 },
        overrep: { Black: 4.8, Hispanic: 0.5, White: 0.4, Other: 0.4 },
        details: {
          Black: { Black: 3184, White: 4646, Hispanic: 3245, Other: 3127 },
          Hispanic: { Hispanic: 1175, White: 1127, Black: 526, Other: 434 },
          White: { White: 1422, Black: 414, Hispanic: 607, Other: 394 },
          Other: { Other: 513, White: 651, Black: 402, Hispanic: 471 }
        }
      },
      kidnapping: {
        label: "Kidnapping",
        total: 1076,
        byRace: { Black: 504, Hispanic: 228, White: 214, Other: 130 },
        pcts: { Black: 46.8, Hispanic: 21.2, White: 19.9, Other: 12.1 },
        overrep: { Black: 3.5, Hispanic: 0.7, White: 0.6, Other: 0.6 },
        details: {
          Black: { Black: 214, White: 127, Hispanic: 68, Other: 95 },
          Hispanic: { Hispanic: 122, White: 56, Black: 25, Other: 25 },
          White: { White: 106, Black: 23, Hispanic: 52, Other: 33 },
          Other: { Other: 61, White: 25, Black: 12, Hispanic: 32 }
        }
      }
    }
  },
  san_jose: {
    name: "San José",
    period: "Jan 2020 – Jun 2025",
    duration: "5 years, 6 months of data",
    dataType: "Suspects",
    population: { Black: 3.0, Hispanic: 31.0, White: 27.0, Asian: 38.5 },
    source: "San José PD Public Records Request",
    sourceLink: "#",
    crimes: {
      homicide: {
        label: "Homicide",
        total: 164,
        byRace: { Black: 23, Hispanic: 98, White: 21, Asian: 22 },
        pcts: { Black: 14.0, Hispanic: 59.8, White: 12.8, Asian: 13.4 },
        overrep: { Black: 4.7, Hispanic: 1.9, White: 0.5, Asian: 0.3 },
        details: {
          Black: { Black: 9, Hispanic: 8, White: 4, Asian: 2 },
          Hispanic: { Hispanic: 68, White: 12, Black: 10, Asian: 6 },
          White: { White: 14, Black: 3, Hispanic: 4, Asian: 0 },
          Asian: { Asian: 9, Black: 0, Hispanic: 6, White: 1 }
        }
      },
      sexual_assault: {
        label: "Sexual Assault",
        total: 877,
        byRace: { Black: 79, Hispanic: 620, White: 105, Asian: 73 },
        pcts: { Black: 9.0, Hispanic: 70.7, White: 12.0, Asian: 8.3 },
        overrep: { Black: 3.0, Hispanic: 2.3, White: 0.4, Asian: 0.2 },
        details: {
          Black: { Black: 17, Hispanic: 39, White: 13, Asian: 4 },
          Hispanic: { Hispanic: 499, White: 62, Black: 9, Asian: 34 },
          White: { White: 44, Black: 6, Hispanic: 35, Asian: 10 },
          Asian: { Asian: 38, Black: 3, Hispanic: 15, White: 9 }
        }
      },
      robbery: {
        label: "Robbery",
        total: 2163,
        byRace: { Black: 513, Hispanic: 1182, White: 369, Asian: 99 },
        pcts: { Black: 23.7, Hispanic: 54.6, White: 17.1, Asian: 4.6 },
        overrep: { Black: 7.9, Hispanic: 1.8, White: 0.6, Asian: 0.1 },
        details: {
          Black: { Black: 46, Hispanic: 204, White: 76, Asian: 121 },
          Hispanic: { Hispanic: 679, White: 161, Black: 50, Asian: 212 },
          White: { White: 97, Black: 10, Hispanic: 150, Asian: 65 },
          Asian: { Asian: 41, Black: 6, Hispanic: 37, White: 11 }
        }
      },
      kidnapping: {
        label: "Kidnapping",
        total: 424,
        byRace: { Black: 112, Hispanic: 232, White: 53, Asian: 27 },
        pcts: { Black: 26.4, Hispanic: 54.7, White: 12.5, Asian: 6.4 },
        overrep: { Black: 8.8, Hispanic: 1.8, White: 0.5, Asian: 0.2 },
        details: {
          Black: { Black: 45, Hispanic: 37, White: 11, Asian: 19 },
          Hispanic: { Hispanic: 193, White: 19, Black: 5, Asian: 15 },
          White: { White: 15, Black: 0, Hispanic: 31, Asian: 7 },
          Asian: { Asian: 17, Black: 1, Hispanic: 5, White: 4 }
        }
      }
    }
  },
  san_francisco: {
    name: "San Francisco",
    period: "Jan 2020 – Mar 2024",
    duration: "4 years, 3 months of data",
    dataType: "Suspects",
    population: { Black: 5.2, Hispanic: 15.6, White: 39.1, Asian: 33.7 },
    source: "San Francisco PD Public Records Request",
    sourceLink: "#",
    crimes: {
      homicide: {
        label: "Homicide",
        total: 184,
        byRace: { Black: 91, Hispanic: 55, White: 24, Asian: 14 },
        pcts: { Black: 49.5, Hispanic: 29.9, White: 13.0, Asian: 7.6 },
        overrep: { Black: 9.5, Hispanic: 1.9, White: 0.3, Asian: 0.2 },
        details: {
          Black: { Black: 65, White: 11, Hispanic: 5, Asian: 8 },
          Hispanic: { Hispanic: 31, Black: 15, White: 6, Asian: 2 },
          White: { White: 9, Black: 7, Hispanic: 5, Asian: 2 },
          Asian: { Asian: 8, Black: 5, Hispanic: 0, White: 0 }
        }
      },
      sexual_assault: { label: "Sexual Assault", pending: true },
      robbery: { label: "Robbery", pending: true },
      kidnapping: { label: "Kidnapping", pending: true }
    }
  },
  oakland: {
    name: "Oakland",
    period: "Jan 2020 – Mar 2024",
    duration: "4 years, 3 months of data",
    dataType: "Suspects",
    population: { Black: 21.0, Hispanic: 28.0, White: 27.0, Asian: 15.0 },
    source: "Oakland PD Public Records Request (PRR 24-2714)",
    sourceLink: "#",
    crimes: {
      homicide: {
        label: "Homicide",
        total: 226,
        byRace: { Black: 147, Hispanic: 52, White: 8, Asian: 6 },
        pcts: { Black: 65.0, Hispanic: 23.0, White: 3.5, Asian: 2.7 },
        overrep: { Black: 3.1, Hispanic: 0.8, White: 0.1, Asian: 0.2 },
        details: {
          Black: { Black: 106, Hispanic: 17, White: 7, Asian: 10, Other: 7 },
          Hispanic: { Black: 6, Hispanic: 42, White: 2, Asian: 0, Other: 2 },
          White: { Black: 1, Hispanic: 3, White: 3, Asian: 1 },
          Asian: { Black: 2, Hispanic: 0, White: 0, Asian: 4 }
        }
      },
      sexual_assault: { label: "Sexual Assault", pending: true },
      robbery: { label: "Robbery", pending: true },
      kidnapping: { label: "Kidnapping", pending: true }
    }
  }
};

const deniedCities = {
  los_angeles: { name: "Los Angeles", status: "denied", note: "Request pending" },
  long_beach: { name: "Long Beach", status: "denied", note: "Request denied" },
  san_diego: { name: "San Diego", status: "denied", note: "No response" },
  fresno: { name: "Fresno", status: "denied", note: "Request pending" },
  bakersfield: { name: "Bakersfield", status: "denied", note: "Request pending" },
  anaheim: { name: "Anaheim", status: "denied", note: "Request pending" }
};

// Statewide trend data — REAL TOTAL ARRESTS from CA AG Crime in California reports
// 24 years: 2000, 2002–2024 (2001 excluded — duplicate of 2002 data)
const statewideYears = ['00','02','03','04','05','06','07','08','09','10','11','12','13','14','15','16','17','18','19','20','21','22','23','24'];
const statewideRates = {
  homicide: {
    label: "Homicide",
    White:    [374,349,424,409,386,351,373,346,343,293,345,336,284,287,300,298,295,282,258,279,250,273,220,212],
    Black:    [397,455,456,476,487,539,495,436,430,414,421,425,355,388,375,401,376,370,381,462,421,447,389,389],
    Hispanic: [698,897,812,932,946,910,1022,944,907,797,686,796,702,657,684,617,720,672,609,754,726,688,689,629],
    Other:    [158,163,147,161,137,167,127,124,124,134,120,80,82,95,80,124,110,92,104,102,109,77,76,75]
  },
  rape: {
    label: "Rape",
    White:    [694,592,603,515,489,479,495,444,471,422,400,381,364,601,594,632,594,590,499,422,400,389,356,413],
    Black:    [636,598,568,525,522,467,448,454,446,452,364,367,337,462,442,471,512,448,351,391,364,293,272,343],
    Hispanic: [1207,1200,1149,1057,978,1065,1095,1075,1016,956,866,838,810,1190,1249,1250,1264,1303,1226,1109,866,1048,978,1047],
    Other:    [165,159,136,140,109,111,126,130,117,127,128,96,90,191,182,205,187,200,157,145,152,160,170,151]
  },
  robbery: {
    label: "Robbery",
    White:    [3171,3125,3089,3218,3040,3150,3504,3505,3647,3259,3029,3271,3130,2828,3248,3181,3288,3160,2880,2632,2272,2632,2674,2772],
    Black:    [6426,6613,7238,7435,7768,8390,8685,8817,8214,7098,6596,6263,6103,5427,5718,5789,6244,6206,6073,4667,3895,4567,5006,5087],
    Hispanic: [6110,6411,6413,6470,6552,7889,8425,9152,8773,7822,7061,6660,6066,5899,6267,6224,6703,6650,6513,5806,4687,5376,5882,6602],
    Other:    [815,808,761,741,858,947,1000,1014,976,842,778,673,635,645,670,698,765,697,646,591,522,612,681,751]
  },
  kidnapping: {
    label: "Kidnapping",
    White:    [416,407,410,452,431,367,392,321,383,333,342,318,349,302,350,413,400,365,357,347,310,309,300,328],
    Black:    [309,365,330,354,399,382,438,383,373,383,329,345,353,328,368,370,387,413,394,361,298,342,302,334],
    Hispanic: [809,874,891,780,828,862,867,924,843,693,801,772,671,673,759,782,830,819,803,783,802,742,730,786],
    Other:    [104,118,65,91,100,107,103,98,85,82,78,77,92,83,122,107,110,105,112,98,95,116,111,110]
  }
};

// 24-year averages for comparison bars — FROM SOURCE FILE
const stateAvg = {
  population: { White: 40.4, Black: 6.0, Hispanic: 36.9, Other: 17.0 },
  homicide: { White: 20.1, Black: 26.4, Hispanic: 47.5, Other: 6.0 },
  rape: { White: 24.0, Black: 19.0, Hispanic: 51.0, Other: 6.0 },
  robbery: { White: 17.0, Black: 38.0, Hispanic: 40.5, Other: 4.5 },
  kidnapping: { White: 22.2, Black: 21.3, Hispanic: 51.5, Other: 5.0 }
};

const raceColors = {
  Black: '#c840e9',
  Hispanic: '#e8853a',
  White: '#4ea8de',
  Other: '#e8d44d',
  Asian: '#e8d44d'
};

// ==================== AMBIENT AUDIO ====================
let audioCtx = null;
let audioPlaying = false;
let masterGain = null;

function initAudio() {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  masterGain = audioCtx.createGain();
  masterGain.gain.value = 0;
  masterGain.connect(audioCtx.destination);

  // Dark drone - low pad
  function createDrone(freq, detune, vol) {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    const filter = audioCtx.createBiquadFilter();
    
    osc.type = 'sine';
    osc.frequency.value = freq;
    osc.detune.value = detune;
    
    filter.type = 'lowpass';
    filter.frequency.value = 400;
    filter.Q.value = 1;
    
    gain.gain.value = vol;
    
    osc.connect(filter);
    filter.connect(gain);
    gain.connect(masterGain);
    osc.start();
    
    // Slow LFO on filter
    const lfo = audioCtx.createOscillator();
    const lfoGain = audioCtx.createGain();
    lfo.frequency.value = 0.05 + Math.random() * 0.08;
    lfoGain.gain.value = 150;
    lfo.connect(lfoGain);
    lfoGain.connect(filter.frequency);
    lfo.start();
    
    return { osc, gain, filter };
  }

  // Create layered drones for noir ambience
  createDrone(55, 0, 0.12);     // Deep bass A
  createDrone(55, 5, 0.08);     // Slightly detuned
  createDrone(82.4, -3, 0.06);  // Low E
  createDrone(110, 2, 0.04);    // A octave up
  createDrone(146.8, 0, 0.02);  // D - adds tension
  
  // Subtle noise for texture
  const bufferSize = 2 * audioCtx.sampleRate;
  const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
  const output = noiseBuffer.getChannelData(0);
  for (let i = 0; i < bufferSize; i++) {
    output[i] = Math.random() * 2 - 1;
  }
  
  const noise = audioCtx.createBufferSource();
  const noiseGain = audioCtx.createGain();
  const noiseFilter = audioCtx.createBiquadFilter();
  
  noise.buffer = noiseBuffer;
  noise.loop = true;
  noiseFilter.type = 'bandpass';
  noiseFilter.frequency.value = 200;
  noiseFilter.Q.value = 0.5;
  noiseGain.gain.value = 0.008;
  
  noise.connect(noiseFilter);
  noiseFilter.connect(noiseGain);
  noiseGain.connect(masterGain);
  noise.start();
}

function toggleAudio() {
  if (!audioCtx) {
    initAudio();
  }
  
  const bars = document.querySelectorAll('.audio-bar');
  
  if (!audioPlaying) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    masterGain.gain.linearRampToValueAtTime(1, audioCtx.currentTime + 2);
    bars.forEach(b => { b.classList.remove('muted'); b.classList.add('playing'); });
    audioPlaying = true;
  } else {
    masterGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 1);
    bars.forEach(b => { b.classList.add('muted'); b.classList.remove('playing'); });
    audioPlaying = false;
  }
}

// ==================== COUNTER ANIMATION ====================
function animateCounter(el, target, suffix = '') {
  const duration = 1500;
  const start = performance.now();
  const startVal = 0;
  
  function update(now) {
    const elapsed = now - start;
    const progress = Math.min(elapsed / duration, 1);
    const eased = 1 - Math.pow(1 - progress, 3);
    const current = Math.round(startVal + (target - startVal) * eased);
    el.textContent = current + suffix;
    if (progress < 1) requestAnimationFrame(update);
  }
  requestAnimationFrame(update);
}

// ==================== PREVIEW CARD ====================
const previewCard = document.getElementById('previewCard');
let previewTimeout;

function showPreview(cityId, event) {
  clearTimeout(previewTimeout);
  const card = previewCard;
  card.dataset.cityId = cityId;
  card.style.cursor = cityData[cityId] ? 'pointer' : 'default';
  
  // Capture cursor position IMMEDIATELY (event gets recycled)
  const cursorX = event.clientX;
  const cursorY = event.clientY;
  
  // Build card content first
  if (cityData[cityId]) {
    const city = cityData[cityId];
    const crimes = city.crimes;
    card.className = 'preview-card active';
    card.innerHTML = `
      <div class="preview-card-title">${city.name}</div>
      ${city.prrDenied ? '<div style="font-family:Source Code Pro,monospace;font-size:7px;letter-spacing:1.5px;color:#d4880e;text-transform:uppercase;margin-bottom:4px;">⚠ PRR DENIED · PUBLIC DATA</div>' : ''}
      <div class="preview-card-period">${city.period} · ${city.dataType}</div>
      <div class="preview-mini-chart">
        ${Object.keys(crimes).map(key => {
          if (crimes[key].pending) {
            return `
              <div class="mini-stat">
                <div class="mini-stat-value" style="font-size:10px; color:var(--text-muted);">—</div>
                <div class="mini-stat-label">${crimes[key].label}</div>
              </div>
            `;
          }
          return `
          <div class="mini-stat">
            <div class="mini-stat-value">${crimes[key].total.toLocaleString()}</div>
            <div class="mini-stat-label">${crimes[key].label}</div>
          </div>
        `}).join('')}
      </div>
      ${Object.keys(crimes).filter(key => !crimes[key].pending).slice(0,2).map(key => {
        const crime = crimes[key];
        const maxPct = Math.max(...Object.values(crime.pcts));
        return `
          <div style="margin-bottom: 8px;">
            <div class="preview-bar-label"><span>${crime.label}</span></div>
            ${Object.entries(crime.pcts).map(([race, pct]) => `
              <div class="preview-bar">
                <div class="preview-bar-fill" style="width: ${(pct/maxPct)*100}%; background: ${raceColors[race]};"></div>
              </div>
            `).join('')}
          </div>
        `;
      }).join('')}
      <div style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin:10px 0 6px;">
        ${Object.keys(city.population).map(race => `
          <div style="display:flex; align-items:center; gap:3px;">
            <div style="width:8px; height:8px; border-radius:2px; background:${raceColors[race]};"></div>
            <span style="font-size:9px; font-family:'Source Code Pro',monospace; color:var(--text-muted);">${race}</span>
          </div>
        `).join('')}
      </div>
      <div class="preview-cta">Click to explore →</div>
    `;
  } else if (deniedCities[cityId]) {
    const city = deniedCities[cityId];
    card.className = 'preview-card active';
    card.innerHTML = `
      <div class="preview-card-title" style="color: var(--text-muted);">${city.name}</div>
      <div class="preview-card-period">${city.note}</div>
      <div class="denied-stamp">Records<br>Denied</div>
      <div style="font-size: 12px; color: var(--text-muted); text-align: center; margin-top: 8px;">
        This city did not comply with our public records request.
      </div>
    `;
  }
  
  // Position card to the RIGHT of cursor, ~20px gap
  // Use known card heights instead of measuring (avoids layout timing bugs)
  const isDataCity = !!cityData[cityId];
  const estCardH = isDataCity ? 420 : 180; // data cities are taller than denied
  const cardW = 300;
  const vw = window.innerWidth;
  const vh = window.innerHeight;
  
  // Horizontal: always right of cursor. If no room, flip left.
  let left = cursorX + 20;
  if (left + cardW > vw - 10) left = cursorX - cardW - 20;
  if (left < 10) left = 10;
  
  // Vertical: align top of card ~40px above cursor so cursor points into card
  // Then clamp so the entire card stays on screen
  let top = cursorY - 40;
  // Don't let it go below viewport
  if (top + estCardH > vh - 10) top = vh - estCardH - 10;
  // Don't let it go above viewport
  if (top < 10) top = 10;
  
  card.style.left = left + 'px';
  card.style.top = top + 'px';
}

function hidePreview() {
  previewTimeout = setTimeout(() => {
    previewCard.className = 'preview-card';
  }, 300);
}

// Keep preview alive when hovering the card itself
previewCard.addEventListener('mouseenter', () => {
  clearTimeout(previewTimeout);
});
previewCard.addEventListener('mouseleave', () => {
  hidePreview();
});
previewCard.addEventListener('click', () => {
  const cityId = previewCard.dataset.cityId;
  if (cityId && cityData[cityId]) {
    switchCity(cityId);
    document.getElementById('cities').scrollIntoView({ behavior: 'smooth' });
    hidePreview();
  } else if (cityId) {
    document.getElementById('transparency').scrollIntoView({ behavior: 'smooth' });
    hidePreview();
  }
});

// Click handlers
document.querySelectorAll('.city-marker').forEach(marker => {
  marker.addEventListener('click', () => {
    const cityId = marker.dataset.city;
    if (cityData[cityId]) {
      switchCity(cityId);
      document.getElementById('cities').scrollIntoView({ behavior: 'smooth' });
    } else {
      document.getElementById('transparency').scrollIntoView({ behavior: 'smooth' });
    }
  });
});

// ==================== CITY DETAIL ====================
let currentCity = 'sacramento';

function switchCity(cityId) {
  currentCity = cityId;
  document.querySelectorAll('.city-tab').forEach(tab => {
    const matches = (cityId === 'sacramento' && tab.textContent === 'Sacramento') ||
                    (cityId === 'san_jose' && tab.textContent === 'San José') ||
                    (cityId === 'san_francisco' && tab.textContent === 'San Francisco') ||
                    (cityId === 'oakland' && tab.textContent === 'Oakland');
    tab.classList.toggle('active', matches);
  });
  renderCityDetail(cityId);
  // Re-bind tooltips for new city bars
  setTimeout(() => setupTrendTooltips(), 100);
}

function renderCityDetail(cityId) {
  const city = cityData[cityId];
  if (!city) return;
  showPct = false; // reset toggle on city switch
  const container = document.getElementById('cityDetailContent');
  const raceKeys = Object.keys(city.population);
  
  container.innerHTML = `
    ${city.prrDenied ? `
    <div class="prr-ribbon-wrap" style="background:rgba(212,136,14,0.04); border:1px solid rgba(212,136,14,0.15); padding:16px; padding-top:50px; margin-bottom:20px;">
      <div class="prr-ribbon">PRR DENIED<span class="prr-ribbon-sub">Public Data Used</span></div>
      <div style="text-align:center;">
        <div class="prr-source-badge">⚠ ${city.dataSourceNote || 'Data sourced from public city dashboard — not from a public records request'}</div>
      </div>
    </div>` : ''}
    <div class="city-date-display">
      <div class="city-date-label">${city.source}</div>
      <div class="city-date-value" id="cityDateTypewriter">${city.period}</div>
      <div style="display:block; text-align:center;">
        <div class="city-date-duration" id="cityDurationTypewriter">${city.duration}</div>
      </div>
    </div>
    <div class="view-toggle" style="margin-top: 24px; margin-bottom: 12px;">
      <span class="view-toggle-label active" id="toggleLabelCount">count</span>
      <div class="view-toggle-switch" id="viewToggle" onclick="toggleView()"></div>
      <span class="view-toggle-label" id="toggleLabelPct">% share</span>
    </div>
    <div style="text-align: center; margin-bottom: 28px; font-family: 'Source Code Pro', monospace; font-size: 10px; color: var(--text-muted); line-height: 1.8;">
      <span style="color: var(--text-secondary); font-weight: 600;">rate</span> = ${city.dataType.toLowerCase()} share ÷ population share <span style="opacity: 0.6;">(1.0 = proportional)</span>
    </div>
    <div class="detail-grid">
      ${Object.entries(city.crimes).map(([key, crime]) => {
        if (crime.pending) {
          return `
            <div class="crime-card-pending">
              <div class="pending-label">${crime.label}</div>
              <div class="pending-badge">Data Pending</div>
              <div class="pending-note">Records request in progress</div>
            </div>
          `;
        }
        const maxCount = Math.max(...Object.values(crime.byRace));
        const repValues = Object.entries(crime.overrep).map(([r,v]) => ({race:r, val:v}));
        repValues.sort((a,b) => b.val - a.val);
        const rankMap = {};
        repValues.forEach((item, i) => {
          rankMap[item.race] = i === 0 ? 'rank-high' : i === 1 ? 'rank-mid' : 'rank-low';
        });
        return `
          <div class="crime-card" onclick="openModal('${cityId}', '${key}')">
            <div class="crime-card-header">
              <div class="crime-card-type">${crime.label}</div>
              <div class="crime-card-total">${crime.total.toLocaleString()} <span>${city.dataType.toLowerCase()}</span></div>
              <div class="crime-card-period">${city.period}</div>
            </div>
            <div class="race-bars">
              <div class="race-bar-header">
                <div class="race-bar-header-spacer"></div>
                <div class="race-bar-header-bar bar-header-label">count</div>
                <div class="race-bar-header-meta">
                  <span>rate</span>
                </div>
              </div>
              ${raceKeys.map(race => {
                const count = crime.byRace[race] || 0;
                const pct = crime.pcts[race] || 0;
                const pop = city.population[race];
                const rep = crime.overrep[race];
                const barWidth = (count / maxCount) * 100;
                const rankClass = rankMap[race];
                const isSmallBar = barWidth < 20;
                return `
                  <div class="race-bar-row" data-tt-race="${race}" data-tt-color="${raceColors[race]}" data-tt-pop="${pop}" data-tt-city="${city.name}">
                    <div class="race-bar-label">${race}</div>
                    <div class="race-bar-track">
                      <div class="race-bar-fill" style="width: 0%; background: ${raceColors[race]}; overflow: visible; position: relative;" data-width="${barWidth}" data-count="${count.toLocaleString()}" data-pct="${pct}%">
                        ${isSmallBar ? `<span class="bar-count-outside">${count.toLocaleString()}</span>` : count.toLocaleString()}
                      </div>
                    </div>
                    <div class="race-bar-meta">
                      <span class="disproportion-badge ${rankClass}">${rep}x</span>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }).join('')}
    </div>
    
    <!-- City-level Population vs Arrest/Suspect Share comparison -->
    <div class="comparison-section" style="margin-top: 48px;">
      <div class="section-header" style="margin-bottom: 20px;">
        <div class="section-label">Disproportionality</div>
        <div class="section-title" style="font-size: clamp(18px, 2.5vw, 26px);">Population Share vs. ${city.dataType} Share</div>
        <div class="section-desc">${city.name} · ${city.period}</div>
      </div>
      <div class="comparison-grid">
        ${Object.entries(city.crimes).map(([key, crime]) => {
          if (crime.pending) {
            return `
              <div class="crime-card-pending" style="min-height: 180px;">
                <div class="pending-label">${crime.label}</div>
                <div class="pending-badge">Data Pending</div>
              </div>
            `;
          }
          return `
            <div class="comparison-card">
              <div class="comparison-card-title">${crime.label}</div>
              ${raceKeys.map(race => {
                const pop = city.population[race];
                const arr = crime.pcts[race];
                const diff = arr - pop;
                const diffPct = Math.round((diff / pop) * 100);
                const isOver = diff > 2;
                const isUnder = diff < -2;
                const perCap = crime.overrep[race];
                
                return `
                  <div class="comparison-row" data-tt-race="${race}" data-tt-color="${raceColors[race]}" data-tt-percap="${perCap}" data-tt-pop="${pop}" data-tt-arr="${arr}" data-tt-crime="${crime.label}" data-tt-context="${city.name}">
                    <div class="comparison-row-label" style="color: ${raceColors[race]};">${race}</div>
                    <div class="comparison-bar-pair">
                      <div class="comparison-bar-wrapper">
                        <div class="comparison-bar-tag">Pop</div>
                        <div class="comparison-bar-track">
                          <div class="comparison-bar-fill pop-bar" style="width: ${pop}%; background: ${raceColors[race]};" data-width="${pop}">
                            ${pop < 20 ? `<span class="bar-pct-outside">◂ ${pop}%</span>` : `<span class="bar-pct-inside">${pop}%</span>`}
                          </div>
                        </div>
                      </div>
                      <div class="comparison-bar-wrapper">
                        <div class="comparison-bar-tag">${city.dataType === 'Suspects' ? 'Sus' : 'Arr'}</div>
                        <div class="comparison-bar-track">
                          <div class="comparison-bar-fill" style="width: ${arr}%; background: ${raceColors[race]};" data-width="${arr}">
                            ${arr < 20 ? `<span class="bar-pct-outside">◂ ${arr}%</span>` : `<span class="bar-pct-inside">${arr}%</span>`}
                          </div>
                        </div>
                      </div>
                      ${isOver ? `<div class="comparison-delta over">+${diffPct}% OVER</div>` : 
                        isUnder ? `<div class="comparison-delta under">${diffPct}% UNDER</div>` : 
                        `<div class="comparison-delta" style="color:var(--text-muted);">~Proportional</div>`}
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `;
        }).join('')}
      </div>
    </div>
    
    <a href="${city.sourceLink}" target="_blank" class="source-link" style="margin-top: 24px;">
      📁 View Source Data — ${city.source} (opens Google Drive)
    </a>
  `;
  
  // Animate bars in
  setTimeout(() => {
    container.querySelectorAll('.race-bar-fill').forEach(bar => {
      bar.style.width = bar.dataset.width + '%';
    });
    // Trigger typewriter animation on date (skip on initial render)
    if (!window._skipTypewriter) {
      const dateEl = document.getElementById('cityDateTypewriter');
      if (dateEl) dateEl.classList.add('typing');
      // Duration typewriter starts right after date finishes
      setTimeout(() => {
        const durEl = document.getElementById('cityDurationTypewriter');
        if (durEl) durEl.classList.add('typing');
      }, 1500);
    }
  }, 100);
}

// ==================== MODAL ====================
// ==================== COUNT/PCT TOGGLE ====================
let showPct = false;

function toggleView() {
  showPct = !showPct;
  const toggle = document.getElementById('viewToggle');
  const labelCount = document.getElementById('toggleLabelCount');
  const labelPct = document.getElementById('toggleLabelPct');
  
  toggle.classList.toggle('on', showPct);
  labelCount.classList.toggle('active', !showPct);
  labelPct.classList.toggle('active', showPct);
  
  // Update all bar labels
  document.querySelectorAll('.race-bar-fill').forEach(bar => {
    const count = bar.dataset.count;
    const pct = bar.dataset.pct;
    const val = showPct ? pct : count;
    const outside = bar.querySelector('.bar-count-outside');
    if (outside) {
      outside.textContent = val;
    } else {
      // Replace text node (the count inside the bar)
      const nodes = bar.childNodes;
      for (let i = 0; i < nodes.length; i++) {
        if (nodes[i].nodeType === 3 && nodes[i].textContent.trim()) {
          nodes[i].textContent = val;
          break;
        }
      }
    }
  });
  
  // Update column headers
  document.querySelectorAll('.bar-header-label').forEach(h => {
    h.textContent = showPct ? '% share' : 'count';
  });
}

function openModal(cityId, crimeKey) {
  const city = cityData[cityId];
  const crime = city.crimes[crimeKey];
  if (!crime || crime.pending) return;
  const raceKeys = Object.keys(city.population);
  const modal = document.getElementById('modalInner');
  
  let detailHTML = '';
  
  if (crime.details) {
    const allValues = [];
    Object.values(crime.details).forEach(d => Object.values(d).forEach(v => allValues.push(v)));
    const maxVal = Math.max(...allValues);
    
    detailHTML = `
      <div class="modal-chart-area">
        <div style="font-family: 'Source Code Pro', monospace; font-size: 11px; color: var(--text-muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px;">
          ${city.dataType} by Suspect Race → Victim Race
        </div>
        <div style="font-family: 'DM Sans', sans-serif; font-size: 11px; color: var(--text-muted); margin-bottom: 20px; line-height: 1.5; opacity: 0.7;">
          Each number = count of ${city.dataType.toLowerCase()} where suspect was [race] and victim was [race]
        </div>
        ${Object.entries(crime.details).map(([suspectRace, victims]) => `
          <div style="margin-bottom: 20px;">
            <div class="modal-bar-group-label" style="color: ${raceColors[suspectRace]};">
              ${suspectRace} ${city.dataType.toLowerCase()} (${crime.byRace[suspectRace]} total)
            </div>
            ${Object.entries(victims).map(([victimRace, count]) => {
              const barWidth = (count/maxVal)*100;
              const isSmallBar = barWidth < 20;
              return `
              <div class="modal-bar-row">
                <div class="modal-bar-name">vs. ${victimRace} victims</div>
                <div class="modal-bar-track">
                  <div class="modal-bar-fill" style="width: ${barWidth}%; background: ${raceColors[victimRace]};">
                    ${isSmallBar ? `<span class="bar-count-outside">${count}</span>` : count}
                  </div>
                </div>
              </div>
            `}).join('')}
          </div>
        `).join('')}
      </div>
    `;
  } else {
    const maxCount = Math.max(...Object.values(crime.byRace));
    detailHTML = `
      <div class="modal-chart-area">
        ${raceKeys.map(race => {
          const count = crime.byRace[race] || 0;
          const pct = crime.pcts[race] || 0;
          const rep = crime.overrep[race];
          const barWidth = (count/maxCount)*100;
          const isSmallBar = barWidth < 20;
          return `
            <div class="modal-bar-row" style="margin-bottom: 10px;">
              <div class="modal-bar-name">${race}</div>
              <div class="modal-bar-track">
                <div class="modal-bar-fill" style="width: ${barWidth}%; background: ${raceColors[race]};">
                  ${isSmallBar ? `<span class="bar-count-outside">${count} (${pct}%)</span>` : `${count} (${pct}%)`}
                </div>
              </div>
              <div class="modal-bar-value">${rep}x</div>
            </div>
          `;
        }).join('')}
      </div>
    `;
  }
  
  const insights = raceKeys.map(race => ({
    race, pop: city.population[race], pct: crime.pcts[race], rep: crime.overrep[race]
  })).sort((a, b) => b.rep - a.rep);
  
  // Rank colors: highest=red, 2nd=orange, bottom two=green
  const insightColors = insights.map((item, i) => 
    i === 0 ? 'var(--accent-red)' : i === 1 ? '#e8853a' : '#27ae60'
  );
  
  modal.innerHTML = `
    <div class="modal-title">${city.name} — ${crime.label}</div>
    <div class="modal-subtitle">${city.period} · ${crime.total.toLocaleString()} Total ${city.dataType}</div>
    <div class="modal-insight-grid" style="margin-bottom: 24px;">
      ${insights.map((i, idx) => `
        <div class="modal-insight">
          <div class="modal-insight-num" style="color: ${insightColors[idx]};">
            ${i.rep}x
          </div>
          <div class="modal-insight-label"><span style="color:${raceColors[i.race]}; font-size:13px; font-weight:700;">${i.race}</span> · ${i.pop}% pop → ${i.pct}% ${city.dataType.toLowerCase()}</div>
        </div>
      `).join('')}
    </div>
    ${detailHTML}
    <a href="${city.sourceLink}" target="_blank" class="source-link">
      📁 View Source Data — ${city.source}
    </a>
  `;
  
  document.getElementById('modalOverlay').classList.add('active');
  document.body.style.overflow = 'hidden';
  // Reset scroll hint
  const hint = document.getElementById('modalScrollHint');
  const overlay = document.getElementById('modalOverlay');
  if (hint) { hint.style.display = ''; hint.style.opacity = '1'; }
  overlay.scrollTop = 0;
  overlay.onscroll = () => {
    if (hint && overlay.scrollTop > 60) hint.style.opacity = '0';
  };
}

function closeModal(event) {
  if (event && event.target !== document.getElementById('modalOverlay') && event.target !== document.querySelector('.modal-close')) return;
  document.getElementById('modalOverlay').classList.remove('active');
  document.body.style.overflow = '';
}

function openStatewideModal() {
  const modal = document.getElementById('modalInner');
  const hint = document.getElementById('modalScrollHint');
  if (hint) hint.style.display = 'none';
  modal.innerHTML = `
    <div class="modal-title">California Felony Arrests</div>
    <div class="modal-subtitle">Full 24-Year Dataset (2000–2024) · CA Attorney General Reports</div>
    <div style="color: var(--text-secondary); line-height: 1.7; margin-bottom: 24px;">
      The full statewide felony arrests table contains 24 years of data across all four crime categories, broken down by race with per-capita rates and source links to each year's California Attorney General "Crime in California" report.
    </div>
    <div class="modal-chart-area" style="text-align: center;">
      <div style="font-size: 14px; color: var(--text-primary); margin-bottom: 12px;">
        Click below to view the complete interactive table:
      </div>
      <a href="#" onclick="alert('Link to your ca-arrests-modified-completesep4.html file — replace with actual URL when deployed'); return false;" class="source-link" style="display: inline-flex; max-width: 500px;">
        📊 Open Full California Felony Arrests Analysis →
      </a>
      <div style="font-size: 11px; color: var(--text-muted); margin-top: 16px;">
        Includes links to every annual CA Attorney General report used as source data.
      </div>
    </div>
  `;
  document.getElementById('modalOverlay').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function openSourcesModal() {
  const hint = document.getElementById('modalScrollHint');
  if (hint) hint.style.display = 'none';
  const sources = [
    { year: '2024', url: 'https://data-openjustice.doj.ca.gov/sites/default/files/2025-07/Crime%20In%20CA%202024%20final.pdf', note: 'Page 41' },
    { year: '2023', url: 'https://data-openjustice.doj.ca.gov/sites/default/files/2024-07/Crime%20In%20CA%202023f.pdf' },
    { year: '2022', url: 'https://data-openjustice.doj.ca.gov/sites/default/files/2023-06/Crime%20In%20CA%202022f.pdf' },
    { year: '2021', url: 'https://data-openjustice.doj.ca.gov/sites/default/files/2022-08/Crime%20In%20CA%202021_0.pdf' },
    { year: '2020', url: 'https://data-openjustice.doj.ca.gov/sites/default/files/2022-08/Crime%20In%20CA%202020.pdf' },
    { year: '2019', url: 'https://data-openjustice.doj.ca.gov/sites/default/files/2022-08/Crime%20In%20CA%202019.pdf' },
    { year: '2018', url: 'https://data-openjustice.doj.ca.gov/sites/default/files/2022-08/Crime%20In%20CA%202018%2020190701.pdf' },
    { year: '2017', url: 'https://data-openjustice.doj.ca.gov/sites/default/files/2022-08/cd17.pdf' },
    { year: '2016', url: 'https://data-openjustice.doj.ca.gov/sites/default/files/2022-08/cd16.pdf' },
    { year: '2015', url: 'https://data-openjustice.doj.ca.gov/sites/default/files/2022-08/cd15.pdf' },
    { year: '2014', url: 'https://oag.ca.gov/sites/all/files/agweb/pdfs/cjsc/publications/candd/cd14/cd14.pdf' },
    { year: '2013', url: 'https://oag.ca.gov/sites/all/files/agweb/pdfs/cjsc/publications/candd/cd13/cd13.pdf' },
    { year: '2012', url: 'https://oag.ca.gov/sites/all/files/agweb/pdfs/cjsc/publications/candd/cd12/cd12.pdf' },
    { year: '2011', url: 'https://oag.ca.gov/sites/all/files/agweb/pdfs/cjsc/publications/candd/cd11/cd11.pdf' },
    { year: '2010', url: 'https://oag.ca.gov/sites/all/files/agweb/pdfs/cjsc/publications/candd/cd10/preface.pdf' },
    { year: '2009', url: 'https://oag.ca.gov/sites/all/files/agweb/pdfs/cjsc/publications/candd/cd09/preface.pdf' },
    { year: '2008', url: 'https://oag.ca.gov/sites/all/files/agweb/pdfs/cjsc/publications/candd/cd08/preface.pdf' },
    { year: '2007', url: 'https://oag.ca.gov/sites/all/files/agweb/pdfs/cjsc/publications/candd/cd07/preface.pdf' },
    { year: '2006', url: 'https://oag.ca.gov/sites/all/files/agweb/pdfs/cjsc/publications/candd/cd06-full-report.pdf', note: 'Page 130' },
    { year: '2005', url: 'https://oag.ca.gov/sites/all/files/agweb/pdfs/cjsc/publications/candd/cd05-full-report.pdf', note: 'Page 130' },
    { year: '2004', url: 'https://oag.ca.gov/sites/all/files/agweb/pdfs/cjsc/publications/candd/cd04-full-report.pdf' },
    { year: '2003', url: 'https://oag.ca.gov/sites/all/files/agweb/pdfs/cjsc/publications/candd/cd03-full-report.pdf' },
    { year: '2002', url: 'https://oag.ca.gov/sites/all/files/agweb/pdfs/cjsc/publications/candd/cd02-full-report.pdf' },
    { year: '2001', url: 'https://oag.ca.gov/sites/all/files/agweb/pdfs/cjsc/publications/candd/cd01-full-report.pdf', note: 'Duplicate of 2002 data — 2001 data never published' },
    { year: '2000', url: 'https://oag.ca.gov/sites/all/files/agweb/pdfs/cjsc/publications/candd/cd00-full-report.pdf' },
  ];
  const rows = sources.map(s => {
    const noteHtml = s.note ? `<span style="font-size:9px; color:var(--text-muted); margin-left:8px;">(${s.note})</span>` : '';
    return `<a href="${s.url}" target="_blank" rel="noopener" class="source-report-row">
      <span style="font-family:'Source Code Pro',monospace; font-size:14px; font-weight:700; color:var(--accent-cyan); min-width:44px;">${s.year}</span>
      <span style="font-family:'Source Code Pro',monospace; font-size:10px; color:var(--text-secondary); flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">Crime in California ${s.year}${noteHtml}</span>
      <span style="font-size:10px; color:var(--text-muted);">PDF ↗</span>
    </a>`;
  }).join('');

  const modal = document.getElementById('modalInner');
  modal.innerHTML = `
    <div class="modal-title">Source Reports</div>
    <div class="modal-subtitle">California Attorney General · Crime in California</div>
    <div style="color: var(--text-secondary); line-height: 1.7; margin-bottom: 20px; font-size: 13px;">
      All statewide arrest data is sourced from the California Attorney General's annual "Crime in California" reports. Each link below opens the official PDF for that year.
    </div>
    <div style="border:1px solid rgba(255,255,255,0.06); border-radius:8px; overflow:hidden; max-height:450px; overflow-y:auto;">
      ${rows}
    </div>
    <div style="font-size:10px; color:var(--text-muted); margin-top:16px; text-align:center; line-height:1.6;">
      25 reports · 2000–2024 · Published by the California Department of Justice
    </div>
  `;
  document.getElementById('modalOverlay').classList.add('active');
  document.body.style.overflow = 'hidden';
}

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeModal();
});

// ==================== TREND LINE CHARTS ====================
let statewideMode = 'counts';

function switchStatewideView(mode) {
  statewideMode = mode;
  document.querySelectorAll('.state-toggle-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.mode === mode);
  });
  renderTrendCharts();
  setTimeout(() => setupTrendTooltips(), 100);
  // Re-trigger bar animations
  document.querySelectorAll('.trend-chart-card').forEach(el => el.classList.add('visible'));
}

function renderTrendCharts() {
  const container = document.getElementById('trendCharts');
  const races = ['White', 'Black', 'Hispanic', 'Other'];
  const avgPop = stateAvg.population;
  const mode = statewideMode;
  
  const modeLabels = {
    counts: { title: 'Arrests', sub: 'Total arrests by race', yType: 'count' },
    pct: { title: '% Share', sub: 'Each group\'s share of total arrests', yType: 'pct' },
    rate: { title: 'Rate', sub: 'Arrest share ÷ population share (1.0 = proportional)', yType: 'rate' }
  };
  const ml = modeLabels[mode];
  
  container.innerHTML = Object.entries(statewideRates).map(([key, data]) => {
    // Compute data for current mode
    const modeData = {};
    races.forEach(race => {
      if (mode === 'counts') {
        modeData[race] = data[race];
      } else if (mode === 'pct') {
        modeData[race] = data[race].map((val, i) => {
          const total = races.reduce((sum, r) => sum + data[r][i], 0);
          return total > 0 ? (val / total) * 100 : 0;
        });
      } else { // rate
        modeData[race] = data[race].map((val, i) => {
          const total = races.reduce((sum, r) => sum + data[r][i], 0);
          const share = total > 0 ? (val / total) * 100 : 0;
          return avgPop[race] > 0 ? share / avgPop[race] : 0;
        });
      }
    });
    
    const allVals = races.flatMap(r => modeData[r]);
    const maxVal = Math.max(...allVals);
    const minVal = mode === 'rate' ? 0 : 0;
    const range = maxVal - minVal || 1;
    
    const svgW = 440;
    const svgH = 200;
    const padL = 42;
    const padR = 10;
    const padT = 15;
    const padB = 30;
    const chartW = svgW - padL - padR;
    const chartH = svgH - padT - padB;
    const n = statewideYears.length;
    
    function x(i) { return padL + (i / (n - 1)) * chartW; }
    function y(val) { return padT + chartH - ((val - minVal) / (range * 1.15)) * chartH; }
    
    function fmtY(val) {
      if (mode === 'counts') {
        if (val >= 1000) return (val / 1000).toFixed(1) + 'k';
        return Math.round(val).toLocaleString();
      } else if (mode === 'pct') {
        return Math.round(val) + '%';
      } else {
        return val.toFixed(1) + '×';
      }
    }
    
    function fmtTooltip(race, val) {
      if (mode === 'counts') return val.toLocaleString();
      if (mode === 'pct') return val.toFixed(1) + '%';
      return val.toFixed(2) + '×';
    }
    
    function tooltipSuffix() {
      if (mode === 'counts') return data.label.toLowerCase() + ' arrests';
      if (mode === 'pct') return 'of ' + data.label.toLowerCase() + ' arrests';
      return data.label.toLowerCase() + ' rate';
    }
    
    // Population reference lines for % share mode
    let refLines = '';
    if (mode === 'pct') {
      races.forEach(race => {
        const popY = y(avgPop[race]);
        refLines += `<line x1="${padL}" y1="${popY}" x2="${svgW - padR}" y2="${popY}" stroke="${raceColors[race]}" stroke-width="1" stroke-dasharray="4,4" opacity="0.35"/>`;
      });
    }
    // 1.0 reference line for rate mode
    if (mode === 'rate') {
      const oneY = y(1.0);
      refLines += `<line x1="${padL}" y1="${oneY}" x2="${svgW - padR}" y2="${oneY}" stroke="rgba(255,255,255,0.25)" stroke-width="1" stroke-dasharray="6,4"/>`;
      refLines += `<text x="${svgW - padR + 2}" y="${oneY + 3}" fill="rgba(255,255,255,0.4)" font-size="7" font-family="Source Code Pro">1.0×</text>`;
    }
    
    const lines = races.map(race => {
      const points = modeData[race].map((val, i) => `${x(i)},${y(val)}`).join(' ');
      return `<polyline points="${points}" fill="none" stroke="${raceColors[race]}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" opacity="0.85"/>
        ${modeData[race].map((val, i) => `
          <circle cx="${x(i)}" cy="${y(val)}" r="2.5" fill="${raceColors[race]}" opacity="0.9" class="trend-dot" pointer-events="none"/>
          <circle cx="${x(i)}" cy="${y(val)}" r="10" fill="transparent" class="trend-hit" data-race="${race}" data-val="${fmtTooltip(race, val)}" data-year="'${statewideYears[i]}" data-color="${raceColors[race]}" data-crime="${data.label}" data-suffix="${tooltipSuffix()}" style="cursor:pointer;"/>
        `).join('')}`;
    }).join('');
    
    // Grid lines
    const gridSteps = 4;
    const gridLines = Array.from({length: gridSteps + 1}, (_, i) => {
      const val = minVal + (range * 1.15 / gridSteps) * i;
      const yPos = y(val);
      return `<line x1="${padL}" y1="${yPos}" x2="${svgW - padR}" y2="${yPos}" stroke="rgba(255,255,255,0.06)" stroke-width="1"/>
        <text x="${padL - 5}" y="${yPos + 3}" fill="var(--text-muted)" font-size="8" text-anchor="end" font-family="Source Code Pro">${fmtY(val)}</text>`;
    }).join('');
    
    // X labels
    const xLabels = statewideYears.map((yr, i) => {
      if (i % 4 === 0 || i === n - 1) {
        return `<text x="${x(i)}" y="${svgH - 5}" fill="var(--text-muted)" font-size="8" text-anchor="middle" font-family="Source Code Pro">'${yr}</text>`;
      }
      return '';
    }).join('');
    
    const pctNote = mode === 'pct' ? `<div style="text-align:center; margin-top:2px; font-family:'Source Code Pro',monospace; font-size:7px; color:var(--text-muted); letter-spacing:0.5px;">DASHED LINES = AVG. POPULATION SHARE</div>` : '';
    const rateNote = mode === 'rate' ? `<div style="text-align:center; margin-top:2px; font-family:'Source Code Pro',monospace; font-size:7px; color:var(--text-muted); letter-spacing:0.5px;">DASHED LINE = PROPORTIONAL (1.0×)</div>` : '';
    
    return `
      <div class="trend-chart-card reveal visible stagger-${Object.keys(statewideRates).indexOf(key) % 4 + 1}">
        <div class="trend-chart-title">${data.label} ${ml.title}</div>
        <div class="trend-chart-subtitle">${ml.sub}</div>
        <svg class="trend-svg" viewBox="0 0 ${svgW} ${svgH}">
          ${gridLines}
          ${refLines}
          ${xLabels}
          ${lines}
        </svg>
        <div class="trend-legend">
          ${races.map(r => `
            <div class="trend-legend-item">
              <div class="trend-legend-dot" style="background:${raceColors[r]};"></div>
              <span style="color:${raceColors[r]};">${r}</span>
              <span style="color:#fff; font-size:9px; margin-left:2px; font-weight:700;">${avgPop[r]}%</span>
            </div>
          `).join('')}
        </div>
        <div style="text-align:center; margin-top:4px; font-family:'Source Code Pro',monospace; font-size:8px; color:var(--text-muted); letter-spacing:0.5px;">AVG. POPULATION SHARE (2000\u20132024)</div>
        ${pctNote}${rateNote}
      </div>
    `;
  }).join('');
}

// ==================== COMPARISON BARS ====================
function renderComparison() {
  const grid = document.getElementById('comparisonGrid');
  const crimes = ['homicide', 'rape', 'robbery', 'kidnapping'];
  const labels = { homicide: 'Homicide', rape: 'Rape', robbery: 'Robbery', kidnapping: 'Kidnapping' };
  const races = ['White', 'Black', 'Hispanic', 'Other'];
  
  grid.innerHTML = crimes.map(crime => `
    <div class="comparison-card reveal">
      <div class="comparison-card-title">${labels[crime]}</div>
      ${races.map(race => {
        const pop = stateAvg.population[race];
        const arr = stateAvg[crime][race];
        const diff = arr - pop;
        const diffPct = Math.round((diff / pop) * 100);
        const isOver = diff > 2;
        const isUnder = diff < -2;
        const perCap = (arr / pop).toFixed(1);
        
        return `
          <div class="comparison-row" data-tt-race="${race}" data-tt-color="${raceColors[race]}" data-tt-percap="${perCap}" data-tt-pop="${pop}" data-tt-arr="${arr}" data-tt-crime="${labels[crime]}">
            <div class="comparison-row-label" style="color: ${raceColors[race]};">${race}</div>
            <div class="comparison-bar-pair">
              <div class="comparison-bar-wrapper">
                <div class="comparison-bar-tag">Pop</div>
                <div class="comparison-bar-track">
                  <div class="comparison-bar-fill pop-bar" style="width: ${pop}%; background: ${raceColors[race]};" data-width="${pop}">
                    ${pop < 20 ? `<span class="bar-pct-outside">◂ ${pop}%</span>` : `<span class="bar-pct-inside">${pop}%</span>`}
                  </div>
                </div>
              </div>
              <div class="comparison-bar-wrapper">
                <div class="comparison-bar-tag">Arr</div>
                <div class="comparison-bar-track">
                  <div class="comparison-bar-fill" style="width: ${arr}%; background: ${raceColors[race]};" data-width="${arr}">
                    ${arr < 20 ? `<span class="bar-pct-outside">◂ ${arr}%</span>` : `<span class="bar-pct-inside">${arr}%</span>`}
                  </div>
                </div>
              </div>
              ${isOver ? `<div class="comparison-delta over">+${diffPct}% OVER</div>` : 
                isUnder ? `<div class="comparison-delta under">${diffPct}% UNDER</div>` : 
                `<div class="comparison-delta" style="color:var(--text-muted);">~Proportional</div>`}
            </div>
          </div>
        `;
      }).join('')}
    </div>
  `).join('');
}

// ==================== TRANSPARENCY ====================
function renderTransparency() {
  const allCities = [];
  // Full PRR cities
  Object.entries(cityData).forEach(([id, city]) => {
    if (!city.prrDenied) {
      allCities.push({ name: city.name, status: 'provided', note: 'Full data provided via PRR' });
    }
  });
  // PRR denied but public data available
  Object.entries(cityData).forEach(([id, city]) => {
    if (city.prrDenied) {
      allCities.push({ name: city.name, status: 'public', note: city.dataSourceNote || 'PRR denied · public data used' });
    }
  });
  // Denied with no data
  Object.values(deniedCities).forEach(city => {
    allCities.push(city);
  });
  
  const grid = document.getElementById('transparencyGrid');
  grid.innerHTML = allCities.map(city => `
    <div class="transparency-card">
      <div class="transparency-dot ${city.status === 'provided' ? 'provided' : city.status === 'public' ? 'public' : 'denied'}"></div>
      <div>
        <div class="transparency-city">${city.name}</div>
        <div class="transparency-status">${city.note}</div>
      </div>
    </div>
  `).join('');
}

// ==================== SCROLL ANIMATIONS ====================
function setupScrollAnimations() {
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('visible');
      }
    });
  }, { threshold: 0.1, rootMargin: '0px 0px -40px 0px' });
  
  document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
  
  // Trigger statewide badge slam and duration typewriter every time section scrolls in
  const swSection = document.getElementById('statewide');
  if (swSection) {
    const swObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const badge = document.querySelector('.statewide-year-badge');
          if (badge) { badge.classList.remove('slammed'); void badge.offsetWidth; badge.classList.add('slammed'); }
          setTimeout(() => {
            const durEl = document.getElementById('statewideDurationTypewriter');
            if (durEl) { durEl.classList.remove('typing'); void durEl.offsetWidth; durEl.classList.add('typing'); }
          }, 600);
        } else {
          const badge = document.querySelector('.statewide-year-badge');
          const durEl = document.getElementById('statewideDurationTypewriter');
          if (badge) badge.classList.remove('slammed');
          if (durEl) durEl.classList.remove('typing');
        }
      });
    }, { threshold: 0.1 });
    swObserver.observe(swSection);
  }
}

// Counter animation on hero visible
const heroObserver = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      setTimeout(() => animateCounter(document.getElementById('counterYears'), 24), 800);
      setTimeout(() => animateCounter(document.getElementById('counterCrimes'), 4), 1000);
      setTimeout(() => animateCounter(document.getElementById('counterCities'), 10), 1200);
      heroObserver.disconnect();
    }
  });
}, { threshold: 0.15 });

// Nav
window.addEventListener('scroll', () => {
  document.getElementById('nav').classList.toggle('visible', window.scrollY > 400);
});

// ==================== TREND TOOLTIPS ====================
function setupTrendTooltips() {
  const tooltip = document.getElementById('trendTooltip');
  
  // Helper to show/move/hide tooltip
  function positionTT(e) {
    const rect = tooltip.getBoundingClientRect();
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    let left = e.clientX + 12;
    let top = e.clientY - 30;
    if (left + rect.width > vw - 8) left = e.clientX - rect.width - 12;
    if (left < 8) left = 8;
    if (top + rect.height > vh - 8) top = e.clientY - rect.height - 10;
    if (top < 8) top = 8;
    tooltip.style.left = left + 'px';
    tooltip.style.top = top + 'px';
  }
  function showTT(el, html, e) {
    tooltip.innerHTML = html;
    tooltip.classList.add('visible');
    positionTT(e);
    requestAnimationFrame(() => positionTT(e));
  }
  function moveTT(e) {
    positionTT(e);
  }
  function hideTT() {
    tooltip.classList.remove('visible');
  }
  window.addEventListener('scroll', hideTT, { passive: true });
  
  // 1. Trend chart dots
  document.querySelectorAll('.trend-hit').forEach(hit => {
    hit.addEventListener('mouseenter', (e) => {
      const { race, val, year, color, crime } = hit.dataset;
      showTT(hit, `CA statewide <span class="tt-race" style="color:${color};">${race}</span>: <span class="tt-val">${val}</span> ${crime.toLowerCase()} arrests <span class="tt-year">${year}</span>`, e);
      const dot = hit.previousElementSibling;
      if (dot && dot.classList.contains('trend-dot')) dot.setAttribute('r', '5');
    });
    hit.addEventListener('mousemove', moveTT);
    hit.addEventListener('mouseleave', () => {
      hideTT();
      const dot = hit.previousElementSibling;
      if (dot && dot.classList.contains('trend-dot')) dot.setAttribute('r', '2.5');
    });
  });
  
  // 2. Comparison bars (Pop vs Arr)
  document.querySelectorAll('.comparison-row[data-tt-race]').forEach(row => {
    row.addEventListener('mouseenter', (e) => {
      const { ttRace, ttColor, ttPercap, ttPop, ttArr, ttCrime, ttContext } = row.dataset;
      const ctx = ttContext || 'CA statewide';
      showTT(row, `${ctx} <span class="tt-race" style="color:${ttColor};">${ttRace}</span> ${ttCrime.toLowerCase()}: <span class="tt-val">${ttPercap}×</span> per capita`, e);
    });
    row.addEventListener('mousemove', moveTT);
    row.addEventListener('mouseleave', hideTT);
    row.style.cursor = 'pointer';
  });
  
  // 3. City crime card bars
  document.querySelectorAll('.race-bar-row[data-tt-race]').forEach(row => {
    row.addEventListener('mouseenter', (e) => {
      const { ttRace, ttColor, ttPop, ttCity } = row.dataset;
      showTT(row, `${ttCity} <span class="tt-race" style="color:${ttColor};">${ttRace}</span> population: <span class="tt-val">${ttPop}%</span>`, e);
    });
    row.addEventListener('mousemove', moveTT);
    row.addEventListener('mouseleave', hideTT);
    row.style.cursor = 'pointer';
  });
}

// ==================== MAP SCALING ====================
function scaleMap() {
  // Map now uses CSS aspect-ratio for responsive sizing
}

window.addEventListener('resize', scaleMap);

// ==================== MAP VIEWPORT SCALING ====================
function scaleMapToFit() {
  // Map now uses CSS aspect-ratio for responsive sizing
}

window.addEventListener('resize', scaleMapToFit);

// ==================== INIT ====================
document.addEventListener('DOMContentLoaded', () => {
  window._skipTypewriter = true;
  renderCityDetail('sacramento');
  // Trigger typewriter every time city section scrolls into view
  const citySection = document.getElementById('cities');
  if (citySection) {
    const cityObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          window._skipTypewriter = false;
          const dateEl = document.getElementById('cityDateTypewriter');
          if (dateEl) { dateEl.classList.remove('typing'); void dateEl.offsetWidth; dateEl.classList.add('typing'); }
          setTimeout(() => {
            const durEl = document.getElementById('cityDurationTypewriter');
            if (durEl) { durEl.classList.remove('typing'); void durEl.offsetWidth; durEl.classList.add('typing'); }
          }, 1500);
        } else {
          // Reset when scrolled away so it replays next time
          const dateEl = document.getElementById('cityDateTypewriter');
          const durEl = document.getElementById('cityDurationTypewriter');
          if (dateEl) dateEl.classList.remove('typing');
          if (durEl) durEl.classList.remove('typing');
        }
      });
    }, { threshold: 0.1 });
    cityObserver.observe(citySection);
  }
  renderTrendCharts();
  renderComparison();
  renderTransparency();
  
  // Setup trend chart tooltips
  setupTrendTooltips();
  
  // Delay to let DOM settle
  requestAnimationFrame(() => {
    scaleMapToFit();
    setupScrollAnimations();
    heroObserver.observe(document.getElementById('hero'));
    scaleMap();
    
    // Mobile fallback: if observers don't fire within 3s, force everything visible
    setTimeout(() => {
      const counterEl = document.getElementById('counterYears');
      if (counterEl && counterEl.textContent === '0') {
        animateCounter(document.getElementById('counterYears'), 24);
        animateCounter(document.getElementById('counterCrimes'), 4);
        animateCounter(document.getElementById('counterCities'), 10);
      }
      document.querySelectorAll('.reveal:not(.visible)').forEach(el => el.classList.add('visible'));
    }, 3000);
  });

  // Auto-start ambient audio on first user interaction (browsers block autoplay)
  function autoStartAudio() {
    if (!audioPlaying) {
      if (!audioCtx) initAudio();
      if (audioCtx.state === 'suspended') audioCtx.resume();
      masterGain.gain.linearRampToValueAtTime(1, audioCtx.currentTime + 2);
      audioPlaying = true;
    }
    // Remove all listeners after first trigger
    ['click','scroll','keydown','touchstart'].forEach(evt =>
      document.removeEventListener(evt, autoStartAudio)
    );
  }
  ['click','scroll','keydown','touchstart'].forEach(evt =>
    document.addEventListener(evt, autoStartAudio, { once: false, passive: true })
  );
});
</script>

<script>
// ==================== RAIN EFFECT ====================
(function() {
  const canvas = document.getElementById('rainCanvas');
  const ctx = canvas.getContext('2d');
  let drops = [];
  let animFrame;
  const DROP_COUNT = 180;
  const WIND_ANGLE = 0.12; // slight diagonal
  
  function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  
  function createDrop() {
    const depth = Math.random(); // 0 = far, 1 = close
    return {
      x: Math.random() * canvas.width * 1.2 - canvas.width * 0.1,
      y: Math.random() * canvas.height * -1,
      speed: 4 + depth * 10,
      length: 15 + depth * 30,
      width: 0.3 + depth * 0.8,
      opacity: 0.08 + depth * 0.18,
      depth: depth
    };
  }
  
  function init() {
    resize();
    drops = [];
    for (let i = 0; i < DROP_COUNT; i++) {
      const d = createDrop();
      d.y = Math.random() * canvas.height; // spread initial positions
      drops.push(d);
    }
  }
  
  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    for (let i = 0; i < drops.length; i++) {
      const d = drops[i];
      const dx = Math.sin(WIND_ANGLE) * d.length;
      const dy = Math.cos(WIND_ANGLE) * d.length;
      
      ctx.beginPath();
      ctx.moveTo(d.x, d.y);
      ctx.lineTo(d.x + dx, d.y + dy);
      
      // Mix of cool white and faint red accent
      const r = 180 + d.depth * 50;
      const g = 180 + d.depth * 30;
      const b = 195 + d.depth * 40;
      ctx.strokeStyle = `rgba(${r},${g},${b},${d.opacity})`;
      ctx.lineWidth = d.width;
      ctx.lineCap = 'round';
      ctx.stroke();
      
      // Occasional subtle splash at bottom
      if (d.y > canvas.height - 5 && Math.random() < 0.3) {
        ctx.beginPath();
        ctx.arc(d.x + dx, canvas.height - 2, 1 + d.depth * 1.5, 0, Math.PI, true);
        ctx.strokeStyle = `rgba(${r},${g},${b},${d.opacity * 0.4})`;
        ctx.lineWidth = 0.5;
        ctx.stroke();
      }
      
      // Move
      d.y += d.speed;
      d.x += Math.sin(WIND_ANGLE) * d.speed * 0.3;
      
      // Reset when off screen
      if (d.y > canvas.height + d.length) {
        drops[i] = createDrop();
      }
    }
    
    animFrame = requestAnimationFrame(draw);
  }
  
  // Fade rain based on scroll - full opacity at top, fades after map section
  function updateRainOpacity() {
    const scrollY = window.scrollY || window.pageYOffset;
    const fadeStart = window.innerHeight * 1.5; // start fading after hero + half map
    const fadeEnd = window.innerHeight * 3;     // fully faded by end of map area
    
    if (scrollY < fadeStart) {
      canvas.style.opacity = '0.35';
    } else if (scrollY > fadeEnd) {
      canvas.style.opacity = '0';
    } else {
      const t = (scrollY - fadeStart) / (fadeEnd - fadeStart);
      canvas.style.opacity = String(0.35 * (1 - t));
    }
  }
  
  window.addEventListener('resize', () => { resize(); });
  window.addEventListener('scroll', updateRainOpacity, { passive: true });
  
  init();
  draw();
})();
</script>
<div class="trend-tooltip" id="trendTooltip"></div>
</body>
</html>
